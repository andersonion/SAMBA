#!/usr/bin/env bash
#
# samba_sched_proxy
#
# Container-side client. Sends requests to host daemon for:
#   sbatch, squeue, sacct, scontrol, scancel
#
# The daemon watches an IPC directory for *.req files, runs the
# corresponding real scheduler command on the host, and writes:
#   *.out, *.err, *.status
#

set -euo pipefail

if [[ $# -lt 1 ]]; then
    echo "Usage: samba_sched_proxy <sbatch|squeue|sacct|scontrol|scancel> [args...]" >&2
    exit 1
fi

cmd="$1"
shift || true

case "$cmd" in
    sbatch|squeue|sacct|scontrol|scancel)
        ;;
    *)
        echo "ERROR: unsupported command '$cmd' for samba_sched_proxy" >&2
        exit 1
        ;;
esac

# --- IPC directory (must match daemon) ---
# Prefer SAMBA_SCHED_DIR (set by samba-pipe / _samba_ensure_daemon),
# otherwise fall back to BIGGUS_DISKUS, then /tmp.
if [[ -n "${SAMBA_SCHED_DIR:-}" ]]; then
    SCHED_DIR="$SAMBA_SCHED_DIR"
elif [[ -n "${BIGGUS_DISKUS:-}" ]]; then
    SCHED_DIR="${BIGGUS_DISKUS%/}/samba_sched_ipc"
else
    SCHED_DIR="/tmp/samba_sched_ipc"
fi

mkdir -p "$SCHED_DIR"

# --- Unique request id & file paths ---
req_id="$(date +%s%N)_$$"
base="${SCHED_DIR}/${req_id}"

req_tmp="${base}.req.tmp"
req="${base}.req"
out="${base}.out"
err="${base}.err"
st="${base}.status"

# --- Build a single safely-quoted args string (for eval on host) ---
args_q=""
if [[ "$#" -gt 0 ]]; then
    for a in "$@"; do
        if [[ -z "$args_q" ]]; then
            args_q="$(printf '%q' "$a")"
        else
            args_q+=" $(printf '%q' "$a")"
        fi
    done
fi

# --- Write request file atomically ---
# No surrounding quotes on ARGS_Q; it already contains shell-escaped tokens.
cwd_q="$(printf '%q' "$PWD")"

cat >"$req_tmp" <<EOF
CMD=${cmd}
CWD=${cwd_q}
ARGS_Q=${args_q}
EOF

# Atomic publish so daemon never sees a half-written .req
mv -f "$req_tmp" "$req"

# --- Wait for daemon to create .status file ---
while [[ ! -f "$st" ]]; do
    sleep 0.01
done

rc=1
if [[ -f "$st" ]]; then
    rc="$(cat "$st" 2>/dev/null || echo 1)"
fi

# --- Relay stdout/stderr from host command ---
if [[ -f "$out" ]]; then
    cat "$out"
fi

if [[ -f "$err" ]]; then
    cat "$err" >&2
fi

# --- Cleanup ---
rm -f "$req" "$out" "$err" "$st" 2>/dev/null || true

exit "$rc"
