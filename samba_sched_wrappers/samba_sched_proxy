#!/usr/bin/env bash
#
# samba_sched_proxy
#
# Container-side client. Sends requests to host daemon for:
#   sbatch, squeue, sacct, scontrol, scancel
#
# Expected daemon behavior: sources *.req files.
#

set -euo pipefail

if [[ $# -lt 1 ]]; then
    echo "Usage: samba_sched_proxy <sbatch|squeue|sacct|scontrol|scancel> [args...]" >&2
    exit 1
fi

cmd="$1"
shift || true

case "$cmd" in
    sbatch|squeue|sacct|scontrol|scancel)
        ;;
    *)
        echo "ERROR: unsupported command '$cmd' for samba_sched_proxy" >&2
        exit 1
        ;;
esac

# --- IPC directory (must match daemon) ---
if [[ -n "${SAMBA_SCHED_DIR:-}" ]]; then
    SCHED_DIR="$SAMBA_SCHED_DIR"
elif [[ -n "${BIGGUS_DISKUS:-}" ]]; then
    SCHED_DIR="${BIGGUS_DISKUS%/}/samba_sched_ipc"
else
    SCHED_DIR="/tmp/samba_sched_ipc"
fi

mkdir -p "$SCHED_DIR"

# --- Unique request id ---
req_id="$(date +%s%N)_$$"
req="${SCHED_DIR}/${req_id}.req"
out="${SCHED_DIR}/${req_id}.out"
err="${SCHED_DIR}/${req_id}.err"
st="${SCHED_DIR}/${req_id}.status"

# --- Build a single safely-quoted args string, NO leading space ---
args_q=""
if [[ "$#" -gt 0 ]]; then
    for a in "$@"; do
        if [[ -z "$args_q" ]]; then
            args_q="$(printf '%q' "$a")"
        else
            args_q+=" $(printf '%q' "$a")"
        fi
    done
fi

# --- Write request file (safe to source) ---
# Ensure no spaces around '=' and wrap string values in single quotes.
cwd_q="$(printf '%q' "$PWD")"

cat >"$req" <<EOF
CMD=${cmd}
CWD=${cwd_q}
ARGS_Q='${args_q}'
EOF

# --- Wait for daemon to create .status file ---
while [[ ! -f "$st" ]]; do
    sleep 0.01
done

rc=1
if [[ -f "$st" ]]; then
    rc="$(cat "$st" 2>/dev/null || echo 1)"
fi

# --- Relay stdout/stderr ---
if [[ -f "$out" ]]; then
    cat "$out"
fi

if [[ -f "$err" ]]; then
    cat "$err" >&2
fi

# --- Cleanup ---
rm -f "$req" "$out" "$err" "$st" 2>/dev/null || true

exit "$rc"
