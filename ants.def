Bootstrap: localimage
From: itk.sif

%environment
    export SAMBA_APPS_DIR="${SAMBA_APPS_DIR:-/opt/samba}"
    export ANTSPATH="${ANTSPATH:-${SAMBA_APPS_DIR}/ants/bin}"
    export PATH="${ANTSPATH}:$PATH"
    export ITK_DIR="${ITK_DIR:-/opt/itk/lib/cmake/ITK-5.3}"
    export SRC_ROOT="${SRC_ROOT:-/opt/src}"
    # ðŸ”’ hard default to the commit we agreed: 0ea8e53
    export ANTS_REF="${ANTS_REF:-0ea8e53}"
    export ANTS_TARGETS="${ANTS_TARGETS:-antsRegistration antsApplyTransforms N4BiasFieldCorrection Atropos ImageMath ResampleImageBySpacing ResampleImage SmoothImage MultiplyImages ThresholdImage}"

%post
    # /bin/sh-safe
    set -eu
    SAMBA_APPS_DIR="${SAMBA_APPS_DIR:-/opt/samba}"
    ITK_DIR="${ITK_DIR:-/opt/itk/lib/cmake/ITK-5.3}"
    SRC_ROOT="${SRC_ROOT:-/opt/src}"
    ANTS_REF="${ANTS_REF:-0ea8e53}"
    ANTS_TARGETS="${ANTS_TARGETS:-antsRegistration antsApplyTransforms N4BiasFieldCorrection Atropos ImageMath ResampleImageBySpacing ResampleImage SmoothImage MultiplyImages ThresholdImage}"

    if [ ! -f "${ITK_DIR}/ITKConfig.cmake" ]; then
        echo "ERROR: ITK_DIR='${ITK_DIR}' missing ITKConfig.cmake." >&2; exit 1
    fi

    if command -v apt-get >/dev/null 2>&1; then
      export DEBIAN_FRONTEND=noninteractive
      apt-get update
      apt-get install -y --no-install-recommends \
        build-essential cmake ninja-build git \
        zlib1g-dev libpng-dev libtiff-dev libjpeg-dev \
        libexpat1-dev ca-certificates
      apt-get clean; rm -rf /var/lib/apt/lists/*
    fi

    export CMAKE_PREFIX_PATH="/opt/itk${CMAKE_PREFIX_PATH:+:$CMAKE_PREFIX_PATH}"

    mkdir -p "${SRC_ROOT}"
    cd "${SRC_ROOT}"
    if [ ! -d ANTs ]; then
      git clone https://github.com/ANTsX/ANTs.git
    fi
    cd ANTs
    git fetch --all --tags
    # ðŸ”’ checkout exactly the commit (override-able via ANTS_REF if you really want)
    git checkout --detach "${ANTS_REF}"

    rm -rf build
    mkdir -p build
    cd build

    INSTALL_PREFIX="${SAMBA_APPS_DIR}/ants"

	# Cap parallelism a bit for memory safety
	JOBS="$(nproc)"; [ "$JOBS" -gt 8 ] && JOBS=8
	BUILD_LOG=/tmp/ants_build.log; : > "$BUILD_LOG"
	
	# Build only the core tools SAMBA uses (no umbrella 'all', so Examples don't flood in)
	# Add/remove targets here as needed without touching the rest of the file.
	ANTS_TARGETS="
	  antsRegistration
	  antsApplyTransforms
	  N4BiasFieldCorrection
	  Atropos
	  ImageMath
	  ResampleImageBySpacing
	  ResampleImage
	  SmoothImage
	  MultiplyImages
	  ThresholdImage
	  PrintHeader
	  ConvertImage
	  ConvertImagePixelType
	  SetOrigin
	  SetSpacing
	  ConvertTransformFile
	"
	
	if ! ninja -j "$JOBS" $ANTS_TARGETS >"$BUILD_LOG" 2>&1; then
	  echo "ANTs build failed. Last 200 lines:" >&2
	  tail -n 200 "$BUILD_LOG" >&2
	  exit 1
	fi

    cmake --install . --prefix "${INSTALL_PREFIX}"

    if command -v strip >/dev/null 2>&1; then
      find "${INSTALL_PREFIX}/bin" -type f -perm -111 -exec strip --strip-unneeded {} + 2>/dev/null || true
    fi

%test
    set -eu
    [ -x "${SAMBA_APPS_DIR:-/opt/samba}/ants/bin/antsRegistration" ]
    echo "ANTs core tools present."

%runscript
    exec /bin/sh -c "$@"
