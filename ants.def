Bootstrap: localimage
From: itk.sif

%environment
    export SAMBA_APPS_DIR="${SAMBA_APPS_DIR:-/opt/samba}"
    export ANTSPATH="${ANTSPATH:-${SAMBA_APPS_DIR}/ants/bin}"
    export PATH="${ANTSPATH}:$PATH"
    export ITK_DIR="${ITK_DIR:-/opt/itk/lib/cmake/ITK-5.3}"
    export SRC_ROOT="${SRC_ROOT:-/opt/src}"
    # ðŸ”’ hard default to the commit we agreed: 0ea8e53
    export ANTS_REF="${ANTS_REF:-0ea8e53}"
    export ANTS_TARGETS="${ANTS_TARGETS:-antsRegistration antsApplyTransforms N4BiasFieldCorrection Atropos ImageMath ResampleImageBySpacing ResampleImage SmoothImage MultiplyImages ThresholdImage}"

%post
    set -eu

    # -- Paths/inputs --
    ITK_DIR=/opt/itk/lib/cmake/ITK-5.3
    INSTALL_PREFIX=/opt/samba/ants
    SRC=/opt/src/ANTs
    BUILD=${SRC}/build
    LOG=/tmp/ants_cmake.log

    	# ---------- ensure correct ANTs source/commit ----------
	mkdir -p /opt/src
	cd /opt/src
	if [ ! -d ANTs ]; then
		git clone https://github.com/ANTsX/ANTs.git
	fi
	cd ANTs
	git fetch --all --tags
	# pin to the commit we validated in /tmp debug
	git checkout --detach 0ea8e53

	# ---------- CLEAN OUT ANY SUPERBUILD ARTIFACTS ----------
	rm -rf build ANTS-build ANTS-prefix 2>/dev/null || true
	mkdir -p build
	cd build

	INSTALL_PREFIX="${SAMBA_APPS_DIR}/ants"
	JOBS=1	# low and steady; bump later if stable

	# ---------- CONFIGURE: SUPERBUILD OFF + EXTERNAL ITK ----------
	cmake -G Ninja \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_INSTALL_PREFIX="${INSTALL_PREFIX}" \
		-DITK_DIR:PATH="${ITK_DIR}" \
		-DANTS_SUPERBUILD=OFF \
		-DBUILD_TESTING=OFF \
		-DBUILD_ALL_ANTS_APPS=OFF \
		..

	# fast sanity: show a few available targets (for future debugging)
	ninja -t targets all 2>/dev/null | head -n 40 || true

	# ---------- build only the core CLIs, sequentially for clarity ----------
	WANTED="
		antsRegistration
		antsApplyTransforms
		N4BiasFieldCorrection
		Atropos
		ImageMath
		ResampleImageBySpacing
		ResampleImage
		SmoothImage
		MultiplyImages
		ThresholdImage
		PrintHeader
		ConvertImage
		ConvertImagePixelType
		SetOrigin
		SetSpacing
		ConvertTransformFile
	"

	mkdir -p /tmp/ants_logs
	for tgt in $WANTED; do
		echo "=== Building target: $tgt (j=$JOBS) ==="
		log="/tmp/ants_logs/${tgt}.log"; : > "$log"
		if ! cmake --build . --target "$tgt" -- -j "$JOBS" >"$log" 2>&1; then
			echo "BUILD FAILED for $tgt. Last 120 lines:" >&2
			tail -n 120 "$log" >&2
			exit 1
		fi
	done

	# ---------- INSTALL (or copy from Examples/ if no install rule) ----------
	if ! cmake --install . --prefix "${INSTALL_PREFIX}" ; then
		echo "No install target; copying built binaries to ${INSTALL_PREFIX}/bin"
		mkdir -p "${INSTALL_PREFIX}/bin"
		for t in $WANTED; do
			# common output location for this commit/layout
			if [ -f "Examples/$t" ]; then
				cp -fv "Examples/$t" "${INSTALL_PREFIX}/bin/"
				continue
			fi
			# last resort: ask ninja where the artifact is
			out="$(ninja -t query "$t" 2>/dev/null | awk '/^  outputs:/{print $2; exit}')"
			if [ -n "$out" ] && [ -f "$out" ]; then
				cp -fv "$out" "${INSTALL_PREFIX}/bin/"
			fi
		done
	fi

	# ---------- FINAL SANITY ----------
	if [ ! -x "${INSTALL_PREFIX}/bin/antsRegistration" ]; then
		echo "FATAL: ANTs installation failed â€” ${INSTALL_PREFIX}/bin/antsRegistration not found." >&2
		find "${INSTALL_PREFIX}/bin" -maxdepth 1 -type f -printf '%f\n' | sort | head -n 200 >&2 || true
		exit 1
	fi

	chmod -R a+rX "${INSTALL_PREFIX}"

%test
    set -eu
    [ -x "${SAMBA_APPS_DIR:-/opt/samba}/ants/bin/antsRegistration" ]
    echo "ANTs core tools present."

%runscript
    exec /bin/sh -c "$@"
