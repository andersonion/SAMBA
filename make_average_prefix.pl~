#!/usr/local/pipeline-link/perl
#extra step ls *.final.nii; get runnos within directory 
#use 5.014;	# so push/pop/etc work on scalars (experimental)

my $ANTSPATH = GET_ANTSPATH_COMMANDO #“/Applications/SegmentationSoftware/ANTS”;
my $LOCALPATH = “/Volumes/androsspace/hess/“;

my $commando;
my $source_ch = “fa”; 			# Channel used to generate MDT.
my $source_ch_uc = uc($source_ch); 	# Uppercase version of $source_ch for file directory naming purposes.
my @moving_ch=qw(T2star); 		# Channels to which to apply transforms.
my $registered_ch = “T2star”;  		# Channel 1 from seg_pipeline.
my $current_ch_uc;
my $new_control_ch_uc;
my $current_outpath;
my $optional_tensor_midfix=‘’;
my $warp_suffix = “avg_Warp.nii”;
my $affine_suffix = “initial_Affine.txt”;
my $name_suffix = “reg2_${registered_ch}_strip_reg2_whs”;


if (1) {
$optional_tensor_midfix = “_DTI”;
}

foreach my $new_control_ch (@moving_ch) {
	$new_control_ch_uc = uc($new_control_ch);
	$current_outpath = “$LOCALPATH/CTRL_${new_control_ch_uc}”;
	mkdir($current_outpath); 
}

my @runnos = qw(N40270 N40310 N40320 N40340 N40350 N40370);

foreach my $current_runno (@runnos) {
my $cr = $current_runno;
pop($cr);
my $current_runno_8 = $cr.”8”;

foreach my $current_ch (@moving_ch) {

$current_ch_uc = uc($current_ch);

$source_name = “${current_runno}${optional_tensor_midfix}_${current_ch}_$name_suffix”;

$SOURCEPATH = “$LOCALPATH/CTRL_${source_ch_uc}”;
$INPATH = “/Volumes/cretespace/hess_vbmpipe_test/${current_runno_8}Labels-results”;
$current_outpath = “$LOCALPATH/CTRL_${new_control_ch_uc}/”;

if ($current_ch ne $registered_ch) {		# The following is a flawed conditional that is attempting to account for 2 diff’t conditions: 1) Is current_ch the same as registered_ch? and 2) Is current_ch a tensor file?  Need to fix.
	$in_file = “$INPATH/${current_runno}${optional_tensor_midfix}_${current_ch}_${name_suffix}.nii”; # $current_runno is used for tensor files
	$out_file = “${current_outpath}/${current_runno}${optional_tensor_midfix}_${current_ch}_${name_suffix}_final.nii”;
} else {
	$in_file = “$INPATH/${current_runno_8}_${name_suffix}_strip_reg2_whs”; # $current_runno_8 is used for non-tensor files…?
	$out_file = “${current_outpath}/${current_runno}_${current_ch}_${name_suffix}_final.nii”;
}


$in_file = “$INPATH/${current_runno}${optional_tensor_midfix}_${current_ch}_${name_suffix}.nii”;
$out_file = “${current_outpath}/${current_runno}${optional_tensor_midfix}_${current_ch}_${name_suffix}_final.nii”; # I do not like having the probably inaccurate $optional_tensor_midfix here, but will have to do for now.


$ref_file = $in_file;
$warp_file = $SOURCEPATH/${source_name}/${source_name}_${warp_suffix};
$affine_file = $SOURCEPATH/${source_name}/${source_name}_${affine_suffix};




$commando = “$ANTSPATH/WarpImageMultiTransform 3  ${in_file} ${out_file}  -R ${ref_file} ${warp_file} ${affine_file}”;

system($commando);
}

#/Applications/SegmentationSoftware/ANTS/WarpImageMultiTransform 3 /Volumes/androsspace/hess/CTRL_FA/N40270_DTI_fa_reg2_T2star_strip_reg2_whs.nii /Volumes/androsspace/hess/CTRL_FA/N40270_DTI_fa_reg2_T2star_strip_reg2_whs_final.nii -R /Volumes/androsspace/hess/CTRL_FA/N40270_DTI_fa_reg2_T2star_strip_reg2_whs.nii /Volumes/androsspace/hess/CTRL_FA/N40270_DTI_fa_reg2_T2star_strip_reg2_whs/N40270_DTI_fa_reg2_T2star_strip_reg2_whs_avg_Warp.nii /Volumes/androsspace/hess/CTRL_FA/N40270_DTI_fa_reg2_T2star_strip_reg2_whs/N40270_DTI_fa_reg2_T2star_strip_reg2_whs_initial_Affine.txt

my $current_volume;
my @volume_list;
my $list_of_volumes;

foreach my $new_control_ch (@moving_ch) {
	
	$new_control_ch_uc = uc($new_control_ch);
	$current_path = “$LOCALPATH/CTRL_${new_control_ch_uc}”;
	foreach my $current_runno (@runnos) {
		$current_volume = “${current_path}/${current_runno}${optional_tensor_midfix}_${new_control_ch}_${name_suffix}_final.nii”;
		push(@volume_list,$current_volume);
	}
	$list_of_volumes = join(‘ ‘,@volume_list);
	$commando = “$ANTSPATH/AverageImages 3 final_average.nii 0 ${list_of_volumes}”;
system($commando);
 
}

#/Applications/SegmentationSoftware/ANTS/AverageImages 3 final_average.nii 0 /Volumes/androsspace/hess/CTRL_FA/N40270_DTI_fa_reg2_T2star_strip_reg2_whs_final.nii /Volumes/androsspace/hess/CTRL_FA/N40310_DTI_fa_reg2_T2star_strip_reg2_whs_final.nii /Volumes/androsspace/hess/CTRL_FA/N40320_DTI_fa_reg2_T2star_strip_reg2_whs_final.nii /Volumes/androsspace/hess/CTRL_FA/N40330_DTI_fa_reg2_T2star_strip_reg2_whs_final.nii /Volumes/androsspace/hess/CTRL_FA/N40340_DTI_fa_reg2_T2star_strip_reg2_whs_final.nii /Volumes/androsspace/hess/CTRL_FA/N40350_DTI_fa_reg2_T2star_strip_reg2_whs_final.nii /Volumes/androsspace/hess/CTRL_FA/N40370_DTI_fa_reg2_dwi_strip_reg2_DTI_final.nii




