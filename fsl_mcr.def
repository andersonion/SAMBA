Bootstrap: localimage
From: ants.sif

%labels
    Stage       fsl_mcr
    Maintainer  BJ + ChatGPT (POSIX-sh safe, skinny-FSL ONLY; NO MATLAB)

%environment
    source /opt/env/samba.sh

%post
    set -eu

    # Ensure canonical env file exists
    mkdir -p /opt/env
    [ -f /opt/env/samba.sh ] || { echo "FATAL: /opt/env/samba.sh missing" >&2; exit 1; }

    # Append FSL env into the single canonical env file (NO MATLAB)
    if ! grep -q 'skinny-FSL (stage: fsl_mcr)' /opt/env/samba.sh; then
        cat << 'EOF' >> /opt/env/samba.sh

# ---- skinny-FSL (stage: fsl_mcr) ----
export FSLDIR="${SAMBA_APPS_DIR}/fsl"
export PATH="${FSLDIR}/bin:${PATH}"

EOF
    fi

    # Make it available immediately during build, too
    . /opt/env/samba.sh

    # ---------------------------------------------------------------
    # Base packages (skinny-FSL harvest + diagnostics)
    # ---------------------------------------------------------------
    export DEBIAN_FRONTEND=noninteractive
    apt-get update
    apt-get install -y --no-install-recommends \
       curl ca-certificates unzip xz-utils \
       python3 jq \
       patchelf file rsync \
       libgfortran5 libquadmath0 libstdc++6 libgcc-s1 \
       procps \
       libxext6 libx11-6 libxrender1 libxt6 libice6 libsm6 libuuid1

    apt-get clean
    rm -rf /var/lib/apt/lists/*

    mkdir -p /opt/samba
    chmod 0755 /opt/samba

    # ---------------------------------------------------------------
    # Helper: always run curl with *system* lib search paths
    # ---------------------------------------------------------------
    syscurl() {
        env -i \
            PATH=/usr/sbin:/usr/bin:/sbin:/bin \
            LD_LIBRARY_PATH=/usr/lib/x86_64-linux-gnu:/lib/x86_64-linux-gnu \
            /usr/bin/curl "$@"
    }

    # ---------------------------------------------------------------
    # Skinny-FSL harvest
    # ---------------------------------------------------------------
    build_fsl_mini() {
        set -eu

        FSL_VER="6.0.6"
        FSL_INSTALL_BASE="/opt/samba/.fsl_full"
        FSL_MINI_DIR="/opt/samba/.fsl_mini"

        rm -rf "${FSL_INSTALL_BASE}" "${FSL_MINI_DIR}"
        mkdir -p "${FSL_INSTALL_BASE}" "${FSL_MINI_DIR}"

        TMPINST="$(mktemp -p /tmp fslinstaller.XXXXXX.py)"
        trap 'rm -f "${TMPINST}"' EXIT
        syscurl -fsSL -o "${TMPINST}" https://fsl.fmrib.ox.ac.uk/fsldownloads/fslinstaller.py

        python3 "${TMPINST}" \
            --dest="${FSL_INSTALL_BASE}/${FSL_VER}" \
            --quiet --skip_registration --yes \
            || { echo "FATAL: FSL installer failed" >&2; exit 1; }

        FSL_BIN="$(find "${FSL_INSTALL_BASE}/${FSL_VER}" -type f -name fslmaths -path '*/bin/*' -print -quit || true)"
        if [ -z "${FSL_BIN}" ]; then
            echo "FATAL: could not locate fslmaths under ${FSL_INSTALL_BASE}/${FSL_VER}" >&2
            exit 1
        fi
        FSL_FULL="$(dirname "$(dirname "${FSL_BIN}")")"

        FSL_TOOLS="fslmaths fdr randomise design_ttest2"
        FSL_HELPERS="fslpython fsl_sub"
        FSL_ALL_TO_COPY="${FSL_TOOLS} ${FSL_HELPERS}"

        mkdir -p "${FSL_MINI_DIR}/bin" "${FSL_MINI_DIR}/lib" "${FSL_MINI_DIR}/etc/fslconf" "${FSL_MINI_DIR}/share/fsl/data"

        if [ -d "${FSL_FULL}/etc/fslconf" ]; then
            cp -a "${FSL_FULL}/etc/fslconf/." "${FSL_MINI_DIR}/etc/fslconf/" || true
        fi
        if [ -d "${FSL_FULL}/share/fsl/data" ]; then
            cp -a "${FSL_FULL}/share/fsl/data/." "${FSL_MINI_DIR}/share/fsl/data/" || true
        elif [ -d "${FSL_FULL%/*}/share/fsl/data" ]; then
            cp -a "${FSL_FULL%/*}/share/fsl/data/." "${FSL_MINI_DIR}/share/fsl/data/" || true
        fi

        copy_tool() {
            T="$1"
            P="$(find "${FSL_INSTALL_BASE}/${FSL_VER}" -type f -name "${T}" -perm -111 -path '*/bin/*' -print -quit 2>/dev/null || true)"
            [ -z "${P}" ] && P="$(find "${FSL_INSTALL_BASE}/${FSL_VER}" -type f -name "${T}" -perm -111 -print -quit 2>/dev/null || true)"
            [ -z "${P}" ] && return 1
            cp -a "${P}" "${FSL_MINI_DIR}/bin/${T}"
            ldd "${P}" 2>/dev/null | awk '/=> \//{print $3}' | while read SO; do
                [ -n "${SO}" ] && cp -n "${SO}" "${FSL_MINI_DIR}/lib/" 2>/dev/null || true
            done
            return 0
        }

        for T in ${FSL_ALL_TO_COPY}; do
            copy_tool "${T}" || echo "WARN: ${T} not found under staged FSL" >&2
        done

        find "${FSL_INSTALL_BASE}/${FSL_VER}" -type f -path '*/lib/lib*.so*' -exec cp -n {} "${FSL_MINI_DIR}/lib/" \; 2>/dev/null || true

        if ls "${FSL_MINI_DIR}/lib/libstdc++.so.6."* >/dev/null 2>&1; then
            LATEST="$(ls -1 "${FSL_MINI_DIR}/lib/libstdc++.so.6."* | sort -V | tail -1 | xargs -n1 basename)"
            ln -sfn "${LATEST}" "${FSL_MINI_DIR}/lib/libstdc++.so.6"
        fi

        for SON in libgfortran.so.5 libquadmath.so.0 libblas.so.3 liblapack.so.3; do
            if [ ! -f "${FSL_MINI_DIR}/lib/${SON}" ]; then
                CAND="$(ldconfig -p | awk -v s="${SON}" '$1==s {print $NF}' | head -1 || true)"
                [ -n "${CAND}" ] && cp -n "${CAND}" "${FSL_MINI_DIR}/lib/" || true
            fi
        done

        for B in "${FSL_MINI_DIR}/bin/fslmaths" "${FSL_MINI_DIR}/bin/fdr" "${FSL_MINI_DIR}/bin/randomise"; do
            if [ -x "${B}" ] && file -L "${B}" | grep -q ELF; then
                patchelf --set-rpath '$ORIGIN/../lib' "${B}" || true
                patchelf --remove-needed libomp.so "${B}" || true
            fi
        done

        echo "[skinny-fsl] mini bin contains:"
        ls -l "${FSL_MINI_DIR}/bin" || true

        _run_clean() {
            env -i PATH=/usr/sbin:/usr/bin:/sbin:/bin LD_LIBRARY_PATH=/usr/lib/x86_64-linux-gnu:/lib/x86_64-linux-gnu "$@" || return $?
        }

        _run_clean "${FSL_MINI_DIR}/bin/fdr" --help || true
        _run_clean "${FSL_MINI_DIR}/bin/randomise" --help || true
        _run_clean "${FSL_MINI_DIR}/bin/design_ttest2" --help || true
        _run_clean "${FSL_MINI_DIR}/bin/fslmaths" || true

        ln -sfn "${FSL_MINI_DIR}" /opt/samba/fsl
        rm -rf "${FSL_INSTALL_BASE}"
        echo "[skinny-fsl] OK â€” linked /opt/samba/fsl -> ${FSL_MINI_DIR}"
    }

    build_fsl_mini

%test
    set -eu
    echo "[test] checking skinny FSL..."
    if [ ! -x /opt/samba/fsl/bin/fslmaths ]; then
        echo "FATAL: /opt/samba/fsl/bin/fslmaths missing" >&2
        exit 1
    fi
    ( env -i PATH=/usr/sbin:/usr/bin:/sbin:/bin LD_LIBRARY_PATH=/usr/lib/x86_64-linux-gnu:/lib/x86_64-linux-gnu /opt/samba/fsl/bin/fslmaths ) || true
    ( /opt/samba/fsl/bin/fdr --help >/dev/null 2>&1 ) || true
    ( /opt/samba/fsl/bin/randomise --help >/dev/null 2>&1 ) || true
    ( /opt/samba/fsl/bin/design_ttest2 --help >/dev/null 2>&1 ) || true
    echo "[test] skinny FSL OK"
