Bootstrap: localimage
From: ants.sif

%labels
	Stage		fsl_mcr
	Maintainer	BJ + ChatGPT (POSIX-sh safe)

%environment
	# Minimal runtime env (append-only)
	export FSLDIR=/opt/samba/fsl
	export PATH="/opt/samba/perl5/bin:/opt/samba/perl5libs/bin:${FSLDIR}/bin:/opt/samba/ants/bin:/opt/samba/SAMBA:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
	# Canonical MCR path (we symlink here during build)
	export MCR_ROOT="/opt/MATLAB/MATLAB2015b_runtime/v90"
	if [ -d "${MCR_ROOT}/runtime/glnxa64" ]; then
		export LD_LIBRARY_PATH="${MCR_ROOT}/runtime/glnxa64:${MCR_ROOT}/bin/glnxa64:${MCR_ROOT}/sys/os/glnxa64:${LD_LIBRARY_PATH}"
	fi

%post
	# POSIX sh only
	set -eu

	# ------------------------------------------------------------------
	# Packages needed for MCR install & skinny-FSL harvest
	# ------------------------------------------------------------------
	export DEBIAN_FRONTEND=noninteractive
	apt-get update
	apt-get install -y --no-install-recommends \
		curl ca-certificates unzip xz-utils \
		python3 jq \
		patchelf file rsync \
		libgfortran5 libquadmath0 libstdc++6 libgcc-s1 \
		procps
	apt-get clean
	rm -rf /var/lib/apt/lists/*

	mkdir -p /opt/samba
	chmod 0755 /opt/samba

	# ------------------------------------------------------------------
	# MATLAB MCR R2015b (v90) — install → find → normalize → ldconfig
	# ------------------------------------------------------------------
	MCR_URL="https://ssd.mathworks.com/supportfiles/downloads/R2015b/deployment_files/R2015b/installers/glnxa64/MCR_R2015b_glnxa64_installer.zip"
	MCR_ZIP="/tmp/MCR_R2015b_glnxa64_installer.zip"
	MCR_INSTDIR="/tmp/mcr_installer"
	MCR_CANON="/opt/MATLAB/MATLAB2015b_runtime/v90"

	echo "[mcr] installing MATLAB Runtime R2015b (v90)..."
	curl -fsSL "${MCR_URL}" -o "${MCR_ZIP}"
	unzip -q "${MCR_ZIP}" -d "${MCR_INSTDIR}"

	"${MCR_INSTDIR}/install" \
		-mode silent \
		-agreeToLicense yes \
		-destinationFolder /usr/local/MATLAB/MATLAB_Runtime \
		|| { echo "FATAL: MCR installer failed" >&2; exit 1; }

	# Find the actual vendor install root (pure sh, no arrays)
	ACTUAL_ROOT=""
	for C in \
		/opt/MATLAB/MATLAB2015b_runtime/v90 \
		/opt/MATLAB/MATLAB_Runtime/v90 \
		/usr/local/MATLAB/MATLAB2015b_runtime/v90 \
		/usr/local/MATLAB/MATLAB_Runtime/v90
	do
		if [ -f "${C}/runtime/glnxa64/libmwmclmcrrt.so" ]; then
			ACTUAL_ROOT="${C}"
			break
		fi
	done

	if [ -z "${ACTUAL_ROOT}" ]; then
		echo "FATAL: Could not locate valid MCR v90 runtime after install" >&2
		exit 1
	fi

	# Normalize to canonical path
	if [ "${ACTUAL_ROOT}" != "${MCR_CANON}" ]; then
		mkdir -p "$(dirname "${MCR_CANON}")"
		if [ -e "${MCR_CANON}" ] && [ ! -L "${MCR_CANON}" ]; then
			rm -rf "${MCR_CANON}"
		fi
		ln -sfn "${ACTUAL_ROOT}" "${MCR_CANON}"
	fi

	# Let ld.so find MCR libs without needing LD_LIBRARY_PATH at runtime
	{
		echo "${ACTUAL_ROOT}/runtime/glnxa64"
		echo "${ACTUAL_ROOT}/bin/glnxa64"
		echo "${ACTUAL_ROOT}/sys/os/glnxa64"
	} > /etc/ld.so.conf.d/mcr_v90.conf
	ldconfig

	ls -lh "${MCR_CANON}/runtime/glnxa64/libmwmclmcrrt.so" || true
	rm -rf "${MCR_ZIP}" "${MCR_INSTDIR}"
	echo "[mcr] ok — normalized at ${MCR_CANON}"

	# ------------------------------------------------------------------
	# Skinny-FSL harvest (RUNS LAST) — POSIX sh only (no 'local', no arrays)
	# ------------------------------------------------------------------
	build_fsl_mini() {
		set -eu

		FSL_VER="6.0.6"
		FSL_INSTALL_BASE="/opt/samba/.fsl_full"
		FSL_MINI_DIR="/opt/samba/.fsl_mini"

		rm -rf "${FSL_INSTALL_BASE}" "${FSL_MINI_DIR}"
		mkdir -p "${FSL_INSTALL_BASE}" "${FSL_MINI_DIR}"

		# Fetch installer with scrubbed env so it uses system libcurl
		TMPINST="$(mktemp -p /tmp fslinstaller.XXXXXX.py)"
		trap 'rm -f "${TMPINST}"' EXIT
		env -i PATH=/usr/sbin:/usr/bin:/sbin:/bin LD_LIBRARY_PATH= \
			curl -fsSL -o "${TMPINST}" https://fsl.fmrib.ox.ac.uk/fsldownloads/fslinstaller.py

		python3 "${TMPINST}" \
			--dest="${FSL_INSTALL_BASE}/${FSL_VER}" \
			--quiet --skip_registration --yes \
			|| { echo "FATAL: FSL installer failed" >&2; exit 1; }

		# Locate real root containing bin/fslmaths
		FSL_BIN="$(find "${FSL_INSTALL_BASE}/${FSL_VER}" -type f -name fslmaths -path '*/bin/*' -print -quit || true)"
		if [ -z "${FSL_BIN}" ]; then
			echo "FATAL: could not locate fslmaths under ${FSL_INSTALL_BASE}/${FSL_VER}" >&2
			exit 1
		fi
		FSL_FULL="$(dirname "$(dirname "${FSL_BIN}")")"

		# Tools to include in mini
		FSL_TOOLS="fslmaths fdr randomise design_ttest2"
		FSL_HELPERS="fslpython fsl_sub"
		FSL_ALL_TO_COPY="${FSL_TOOLS} ${FSL_HELPERS}"

		# Mini tree
		mkdir -p "${FSL_MINI_DIR}/bin" "${FSL_MINI_DIR}/lib" "${FSL_MINI_DIR}/etc/fslconf" "${FSL_MINI_DIR}/share/fsl/data"

		# Minimal configs/data if present
		if [ -d "${FSL_FULL}/etc/fslconf" ]; then
			cp -a "${FSL_FULL}/etc/fslconf/." "${FSL_MINI_DIR}/etc/fslconf/" || true
		fi
		if [ -d "${FSL_FULL}/share/fsl/data" ]; then
			cp -a "${FSL_FULL}/share/fsl/data/." "${FSL_MINI_DIR}/share/fsl/data/" || true
		elif [ -d "${FSL_FULL%/*}/share/fsl/data" ]; then
			cp -a "${FSL_FULL%/*}/share/fsl/data/." "${FSL_MINI_DIR}/share/fsl/data/" || true
		fi

		# Copy tool + sweep ELF deps into mini/lib
		copy_tool() {
			T="$1"
			P="$(find "${FSL_INSTALL_BASE}/${FSL_VER}" -type f -name "${T}" -perm -111 -path '*/bin/*' -print -quit 2>/dev/null || true)"
			if [ -z "${P}" ]; then
				P="$(find "${FSL_INSTALL_BASE}/${FSL_VER}" -type f -name "${T}" -perm -111 -print -quit 2>/dev/null || true)"
			fi
			[ -z "${P}" ] && return 1
			cp -a "${P}" "${FSL_MINI_DIR}/bin/${T}"
			ldd "${P}" 2>/dev/null | awk '/=> \//{print $3}' | while read SO; do
				[ -n "${SO}" ] && cp -n "${SO}" "${FSL_MINI_DIR}/lib/" 2>/dev/null || true
			done
			return 0
		}

		for T in ${FSL_ALL_TO_COPY}; do
			copy_tool "${T}" || echo "WARN: ${T} not found under staged FSL" >&2
		done

		# Sweep vendor lib/*.so* we might have missed
		find "${FSL_INSTALL_BASE}/${FSL_VER}" -type f -path '*/lib/lib*.so*' -exec cp -n {} "${FSL_MINI_DIR}/lib/" \; 2>/dev/null || true

		# Ensure modern libstdc++ present, link soname
		if ls "${FSL_MINI_DIR}/lib/libstdc++.so.6."* >/dev/null 2>&1; then
			LATEST="$(ls -1 "${FSL_MINI_DIR}/lib/libstdc++.so.6."* | sort -V | tail -1 | xargs -n1 basename)"
			ln -sfn "${LATEST}" "${FSL_MINI_DIR}/lib/libstdc++.so.6"
		fi

		# Backfill BLAS/LAPACK/GFortran if missing
		for SON in libgfortran.so.5 libquadmath.so.0 libblas.so.3 liblapack.so.3; do
			if [ ! -f "${FSL_MINI_DIR}/lib/${SON}" ]; then
				CAND="$(ldconfig -p | awk -v s="${SON}" '$1==s {print $NF}' | head -1 || true)"
				if [ -n "${CAND}" ]; then
					cp -n "${CAND}" "${FSL_MINI_DIR}/lib/" || true
				fi
			fi
		done

		# Tighten rpath and drop libomp need (if any) — only for ELF bins
		for B in "${FSL_MINI_DIR}/bin/fslmaths" "${FSL_MINI_DIR}/bin/fdr" "${FSL_MINI_DIR}/bin/randomise"; do
			if [ -x "${B}" ] && file -L "${B}" | grep -q ELF; then
				patchelf --set-rpath '$ORIGIN/../lib' "${B}" || true
				patchelf --remove-needed libomp.so "${B}" || true
			fi
		done
		# design_ttest2 is a script — do not patchelf

		echo "[skinny-fsl] mini bin contains:"
		ls -l "${FSL_MINI_DIR}/bin" || true

		echo "[skinny-fsl] ldd check for fdr:"
		ldd "${FSL_MINI_DIR}/bin/fdr" || true

		# Light smoke tests under scrubbed env (no LD_LIBRARY_PATH pollution)
		_run_clean() {
			env -i PATH=/usr/sbin:/usr/bin:/sbin:/bin LD_LIBRARY_PATH=/usr/lib/x86_64-linux-gnu:/lib/x86_64-linux-gnu "$@" || return $?
		}

		# Help/usage checks (do not use `fslmaths -version`)
		_run_clean "${FSL_MINI_DIR}/bin/fdr" --help || true
		_run_clean "${FSL_MINI_DIR}/bin/randomise" --help || true
		_run_clean "${FSL_MINI_DIR}/bin/design_ttest2" --help || true
		_run_clean "${FSL_MINI_DIR}/bin/fslmaths" || true

		ln -sfn "${FSL_MINI_DIR}" /opt/samba/fsl
		rm -rf "${FSL_INSTALL_BASE}"
		echo "[skinny-fsl] OK — linked /opt/samba/fsl -> ${FSL_MINI_DIR}"
	}

	# Run skinny-FSL build LAST
	build_fsl_mini

%test
	# POSIX sh only
	set -eu

	# Verify MCR
	MCR_ROOT="/opt/MATLAB/MATLAB2015b_runtime/v90"
	echo "[test] checking MATLAB MCR v90 ..."
	if [ ! -f "${MCR_ROOT}/runtime/glnxa64/libmwmclmcrrt.so" ]; then
		echo "FATAL: libmwmclmcrrt.so missing under ${MCR_ROOT}" >&2
		exit 1
	fi
	ldd "${MCR_ROOT}/runtime/glnxa64/libmwmclmcrrt.so" >/dev/null || {
		echo "FATAL: ldd failed on MCR core lib" >&2; exit 1;
	}
	echo "[test] MCR OK"

	# Verify FSL mini
	if [ ! -x /opt/samba/fsl/bin/fslmaths ]; then
		echo "FATAL: /opt/samba/fsl/bin/fslmaths missing" >&2
		exit 1
	fi
	( env -i PATH=/usr/sbin:/usr/bin:/sbin:/bin LD_LIBRARY_PATH=/usr/lib/x86_64-linux-gnu:/lib/x86_64-linux-gnu /opt/samba/fsl/bin/fslmaths ) || true
	( /opt/samba/fsl/bin/fdr --help >/dev/null 2>&1 ) || true
	( /opt/samba/fsl/bin/randomise --help >/dev/null 2>&1 ) || true
	( /opt/samba/fsl/bin/design_ttest2 --help >/dev/null 2>&1 ) || true
	echo "[test] FSL skinny OK"
