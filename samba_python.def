Bootstrap: localimage
From: semifinal.sif

%labels
    Maintainer Robert Anderson
    Version v1.0+samba_python

%files
    # Copy your working treeâ€™s SAMBA_python into the image at build time.
    # This requires you to run the build from the SAMBA repo root (or a dir
    # where SAMBA_python exists at this relative path).
    SAMBA_python /opt/SAMBA_python

%environment
    export SAMBA_PY_PREFIX=/opt/conda_envs/samba-py
    export PATH=${SAMBA_PY_PREFIX}/bin:$PATH

%post
    set -eu

    # Prevent MATLAB MCR libs from hijacking build tooling
    unset LD_LIBRARY_PATH || true
    unset LD_PRELOAD || true
    export PATH=/usr/sbin:/usr/bin:/sbin:/bin:$PATH

    # We will not apt-get in this overlay stage (avoids MCR libstdc++ collision)
    # Require curl+tar in the base image:
    if ! command -v curl >/dev/null 2>&1; then
        echo "FATAL: curl not found in base image. Install it in the heavy stage (final.def) once." >&2
        exit 1
    fi
    if ! command -v tar >/dev/null 2>&1; then
        echo "FATAL: tar not found in base image. Install it in the heavy stage (final.def) once." >&2
        exit 1
    fi

    SAMBA_PY_SRC=/opt/SAMBA_python
    if [ ! -d "$SAMBA_PY_SRC" ]; then
        echo "FATAL: /opt/SAMBA_python missing (did %files copy fail?)" >&2
        exit 1
    fi

    # Install micromamba
    mkdir -p /opt/micromamba/bin
    curl -Ls https://micro.mamba.pm/api/micromamba/linux-64/latest \
      | tar -xvj -C /opt/micromamba/bin --strip-components=1 bin/micromamba
    ln -sfn /opt/micromamba/bin/micromamba /usr/local/bin/micromamba

    export MAMBA_ROOT_PREFIX=/opt/micromamba
    export SAMBA_PY_PREFIX=/opt/conda_envs/samba-py
    mkdir -p "$(dirname "$SAMBA_PY_PREFIX")"

    echo "Building SAMBA_python env at prefix: $SAMBA_PY_PREFIX"

    if [ -f "$SAMBA_PY_SRC/environment.lock.yml" ]; then
        echo "Using lock file: $SAMBA_PY_SRC/environment.lock.yml"
        micromamba create -y -p "$SAMBA_PY_PREFIX" -f "$SAMBA_PY_SRC/environment.lock.yml"
    elif [ -f "$SAMBA_PY_SRC/environment.yml" ]; then
        echo "Using env file: $SAMBA_PY_SRC/environment.yml"
        micromamba create -y -p "$SAMBA_PY_PREFIX" -f "$SAMBA_PY_SRC/environment.yml"
    else
        echo "FATAL: neither environment.lock.yml nor environment.yml found under $SAMBA_PY_SRC" >&2
        exit 1
    fi

    micromamba run -p "$SAMBA_PY_PREFIX" python -m pip install --upgrade pip
    micromamba run -p "$SAMBA_PY_PREFIX" python -m pip install indexed_gzip
    micromamba run -p "$SAMBA_PY_PREFIX" python -m pip install -e "$SAMBA_PY_SRC"

    micromamba run -p "$SAMBA_PY_PREFIX" python -c "import samba_py; import samba_py.niigz_io; print('OK: samba_py import')"
    micromamba run -p "$SAMBA_PY_PREFIX" pytest -q "$SAMBA_PY_SRC/tests"

%runscript
    exec bash
