Bootstrap: localimage
From: semifinal.sif

%labels
    Stage: samba_python
    Maintainer: BJ Anderson + ChatGPT (SAMBA_python micromamba env; NO MATLAB)

%environment
    source /opt/env/samba.sh

    # Python env inside container
    export SAMBA_PY_PREFIX=/opt/conda_envs/samba-py
    export PATH="${SAMBA_PY_PREFIX}/bin:${PATH}"

%post
    set -eu

    # ---- hard reset: do NOT inherit any runtime LD_* weirdness during build ----
    unset LD_LIBRARY_PATH || true
    unset LD_PRELOAD || true

    # minimal PATH for build steps (we use absolute paths for curl/tar anyway)
    export PATH=/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/sbin:/usr/local/bin

    # Canonical env from earlier stages
    mkdir -p /opt/env
    [ -f /opt/env/samba.sh ] || { echo "FATAL: /opt/env/samba.sh missing" >&2; exit 1; }
    . /opt/env/samba.sh

    # ---- Locate SAMBA_python as a subfolder of the installed SAMBA repo ----
    SAMBA_PY_SRC="${SAMBA_PATH}/SAMBA_python"
    if [ ! -d "${SAMBA_PY_SRC}" ]; then
        echo "FATAL: SAMBA_python not found at: ${SAMBA_PY_SRC}" >&2
        echo "Expected SAMBA_python to be a subfolder inside the cloned SAMBA repo." >&2
        echo "SAMBA_PATH=${SAMBA_PATH}" >&2
        ls -la "${SAMBA_PATH}" || true
        exit 1
    fi
    echo "[samba_python] Using SAMBA_PY_SRC=${SAMBA_PY_SRC}"

    # ---- System deps needed for micromamba + building wheels if needed ----
    export DEBIAN_FRONTEND=noninteractive
    apt-get update
    apt-get install -y --no-install-recommends \
        ca-certificates curl bzip2 tar \
        build-essential
    apt-get clean
    rm -rf /var/lib/apt/lists/*

    # ---- Install micromamba (system curl + system tar) ----
    mkdir -p /opt/micromamba/bin
    /usr/bin/curl -Ls https://micro.mamba.pm/api/micromamba/linux-64/latest \
      | /bin/tar -xvj -C /opt/micromamba/bin --strip-components=1 bin/micromamba

    ln -sfn /opt/micromamba/bin/micromamba /usr/local/bin/micromamba

    export MAMBA_ROOT_PREFIX=/opt/micromamba
    export SAMBA_PY_PREFIX=/opt/conda_envs/samba-py
    mkdir -p "$(dirname "${SAMBA_PY_PREFIX}")"

    echo "[samba_python] Building env at prefix: ${SAMBA_PY_PREFIX}"

    # ---- Choose lock if present, else fall back to environment.yml ----
    LOCK="${SAMBA_PY_SRC}/environment.lock.yml"
    ENVY="${SAMBA_PY_SRC}/environment.yml"

    SPEC=""
    if [ -f "${LOCK}" ]; then
        echo "[samba_python] Found lock: ${LOCK}"
        SPEC="${LOCK}"
    elif [ -f "${ENVY}" ]; then
        echo "[samba_python] No lock; using: ${ENVY}"
        SPEC="${ENVY}"
    else
        echo "FATAL: neither environment.lock.yml nor environment.yml found in ${SAMBA_PY_SRC}" >&2
        exit 1
    fi

    # ---- Sanitize YAML so micromamba never chokes on name:/prefix: and pip samba-py ----
    #  - remove prefix:
    #  - normalize name: samba-py
    #  - remove pip entry for samba-py (local project; we install -e later)
    SAN="/tmp/samba_python_env_spec.yml"
    rm -f "${SAN}"

    awk '
        # Remove conda-export prefix lines if present
        /^prefix:[[:space:]]/ { next }

        # Normalize any name line, including pathological name: /path/to/env
        /^name:[[:space:]]/ { print "name: samba-py"; next }

        # Drop pip-installed local package (not on PyPI; installed via pip -e later)
        /^[[:space:]]*-[[:space:]]samba-py([=<>!~].*)?[[:space:]]*$/ { next }

        { print }
    ' "${SPEC}" > "${SAN}"

    # ---- Create env (always rebuild in-image to keep deterministic) ----
    if [ -d "${SAMBA_PY_PREFIX}" ]; then
        echo "[samba_python] Removing existing prefix ${SAMBA_PY_PREFIX}"
        rm -rf "${SAMBA_PY_PREFIX}"
    fi

    micromamba create -y -p "${SAMBA_PY_PREFIX}" -f "${SAN}"

    # ---- Install pip extras + editable local package ----
    micromamba run -p "${SAMBA_PY_PREFIX}" python -m pip install --upgrade pip

    # Keep indexed_gzip explicit (optional but useful for IO tools)
    # If it's already in the lock, pip will say "requirement already satisfied" and move on.
    micromamba run -p "${SAMBA_PY_PREFIX}" python -m pip install indexed_gzip

    # Install your package from the source tree (NOT from PyPI)
    micromamba run -p "${SAMBA_PY_PREFIX}" python -m pip install -e "${SAMBA_PY_SRC}"

    # ---- Smoke tests ----
    micromamba run -p "${SAMBA_PY_PREFIX}" python -c "import samba_py; print('samba_py import OK')"
    micromamba run -p "${SAMBA_PY_PREFIX}" pytest -q "${SAMBA_PY_SRC}/tests"

%test
    set -eu
    . /opt/env/samba.sh

    if [ ! -x /opt/conda_envs/samba-py/bin/python ]; then
        echo "FATAL: samba-py python missing at /opt/conda_envs/samba-py/bin/python" >&2
        exit 1
    fi

    /opt/conda_envs/samba-py/bin/python -c "import samba_py; print('OK')"

%runscript
    exec /bin/sh -c "$@"
