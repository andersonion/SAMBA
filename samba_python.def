Bootstrap: localimage
From: semifinal.sif

%labels
    Maintainer Robert Anderson
    Version v1.0+samba_python

%environment
    # Extend runtime PATH so python env is on PATH automatically
    export SAMBA_PY_PREFIX=/opt/conda_envs/samba-py
    export PATH=${SAMBA_PY_PREFIX}/bin:$PATH

    # Optional global kill-switch
    # export SAMBA_NO_PIGZ=1

%post
    # POSIX sh compatible
    set -eu

    # ---------------------------------------------------------------------
    # IMPORTANT: prevent base-image linker settings (MATLAB MCR libs) from
    # hijacking build tools like apt/curl/python. We are not "using MATLAB",
    # we are neutralizing its runtime libs for this build stage.
    # ---------------------------------------------------------------------
    unset LD_LIBRARY_PATH || true
    unset LD_PRELOAD || true
    export PATH=/usr/sbin:/usr/bin:/sbin:/bin:$PATH

    # ---- Where SAMBA lives in the base image ----
    export SAMBA_APPS_DIR=/opt/samba
    export SAMBA_PATH=${SAMBA_APPS_DIR}/SAMBA

    SAMBA_PY_SRC="${SAMBA_PATH}/SAMBA_python"
    if [ ! -d "$SAMBA_PY_SRC" ]; then
        echo "FATAL: SAMBA_python not found at: $SAMBA_PY_SRC" >&2
        echo "Expected SAMBA_python to be a subfolder inside the cloned SAMBA repo." >&2
        exit 1
    fi

    # ---- Assert required base tools exist (no apt-get in this stage) ----
    # We only need curl + tar to fetch micromamba.
    if ! command -v curl >/dev/null 2>&1; then
        echo "FATAL: curl not found in base image. Install it in the heavy stage (final.def) once." >&2
        exit 1
    fi
    if ! command -v tar >/dev/null 2>&1; then
        echo "FATAL: tar not found in base image. Install it in the heavy stage (final.def) once." >&2
        exit 1
    fi

    # pigz is optional; your runtime will fall back automatically.
    if command -v pigz >/dev/null 2>&1; then
        echo "INFO: pigz is present: $(command -v pigz)"
    else
        echo "INFO: pigz not present in base image; streaming will fall back (OK)."
    fi

    # ---- Install micromamba (static binary) ----
    mkdir -p /opt/micromamba/bin
    curl -Ls https://micro.mamba.pm/api/micromamba/linux-64/latest \
      | tar -xvj -C /opt/micromamba/bin --strip-components=1 bin/micromamba
    ln -sfn /opt/micromamba/bin/micromamba /usr/local/bin/micromamba

    export MAMBA_ROOT_PREFIX=/opt/micromamba
    export SAMBA_PY_PREFIX=/opt/conda_envs/samba-py
    mkdir -p "$(dirname "$SAMBA_PY_PREFIX")"

    echo "Building SAMBA_python env at prefix: $SAMBA_PY_PREFIX"

    # Prefer lock if present; fall back to environment.yml
    if [ -f "$SAMBA_PY_SRC/environment.lock.yml" ]; then
        echo "Using lock file: $SAMBA_PY_SRC/environment.lock.yml"
        micromamba create -y -p "$SAMBA_PY_PREFIX" -f "$SAMBA_PY_SRC/environment.lock.yml"
    elif [ -f "$SAMBA_PY_SRC/environment.yml" ]; then
        echo "Using env file: $SAMBA_PY_SRC/environment.yml"
        micromamba create -y -p "$SAMBA_PY_PREFIX" -f "$SAMBA_PY_SRC/environment.yml"
    else
        echo "FATAL: neither environment.lock.yml nor environment.yml found under $SAMBA_PY_SRC" >&2
        exit 1
    fi

    # pip extras + editable install
    micromamba run -p "$SAMBA_PY_PREFIX" python -m pip install --upgrade pip
    micromamba run -p "$SAMBA_PY_PREFIX" python -m pip install indexed_gzip
    micromamba run -p "$SAMBA_PY_PREFIX" python -m pip install -e "$SAMBA_PY_SRC"

    # Build-time smoke tests
    micromamba run -p "$SAMBA_PY_PREFIX" python -c "import samba_py; import samba_py.niigz_io; print('OK: samba_py import')"
    micromamba run -p "$SAMBA_PY_PREFIX" pytest -q "$SAMBA_PY_SRC/tests"

%runscript
    exec bash
