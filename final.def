Bootstrap: localimage
From: fsl_mcr.sif

%labels
    Stage     final
    Maintainer  "BJ + SAMBA container stack"

%help
    Final SAMBA image layered on top of fsl_mcr.sif.
    - Assumes fsl_mcr.sif already contains:
        * ANTs (under /opt/samba/ants or similar)
        * FSL mini (under /opt/samba/fsl)
        * MATLAB Runtime v90
        * Perl + Carton + SAMBA dependencies
        * (Optionally) atlas under /opt/atlases/chass_symmetric3
    - This stage:
        * Installs the SAMBA repo into /opt/samba/SAMBA
        * Installs helper binaries + scheduler wrappers into /opt/samba/bin
        * Sets environment for runtime use
        * Adds a non-fatal %test that only warns if atlas is missing

%environment
    # Runtime environment inside the container
    export SAMBA_ROOT=/opt/samba
    export SAMBA_PATH=/opt/samba/SAMBA

    # If atlas is present in the image, this will be the default
    export SAMBA_ATLAS_DIR=/opt/atlases/chass_symmetric3

    # Prefer SAMBA tools + FSL + ANTs
    export PATH="/opt/samba/bin:/opt/samba/fsl/bin:/opt/samba/ants/bin:${PATH}"

%post
    set -eu

    SAMBA_ROOT=/opt/samba
    SAMBA_PATH=/opt/samba/SAMBA

    mkdir -p /opt/src "${SAMBA_ROOT}"
    chmod 0755 "${SAMBA_ROOT}"

    echo "[final] cloning SAMBA from GitHub..."
    if [ ! -d /opt/src/SAMBA ]; then
        git clone https://github.com/andersonion/SAMBA.git /opt/src/SAMBA
    fi
    git -C /opt/src/SAMBA fetch --all --tags --prune

    # Pin to origin/master (your canonical branch)
    SAMBA_REF=master
    echo "[final] checking out SAMBA ref '${SAMBA_REF}'..."
    git -C /opt/src/SAMBA show-ref --verify --quiet "refs/remotes/origin/${SAMBA_REF}" || {
        echo "FATAL: cannot resolve origin/${SAMBA_REF} in /opt/src/SAMBA" >&2
        exit 1
    }
    git -C /opt/src/SAMBA checkout -f -B buildpin "origin/${SAMBA_REF}"

    echo "[final] installing SAMBA into ${SAMBA_PATH}..."
    rm -rf "${SAMBA_PATH}.tmp"
    rsync -a --delete /opt/src/SAMBA/ "${SAMBA_PATH}.tmp"/
    mv -f "${SAMBA_PATH}.tmp" "${SAMBA_PATH}"
    chmod -R a+rX "${SAMBA_PATH}"

    echo "[final] installing SAMBA helper binaries and scheduler wrappers..."
    mkdir -p "${SAMBA_ROOT}/bin"

    # Helper "fake" slurm frontends (sacct, sbatch, squeue, scancel, scontrol)
    if [ -d "${SAMBA_PATH}/samba_bin" ]; then
        cp -f \
            "${SAMBA_PATH}/samba_bin/sacct" \
            "${SAMBA_PATH}/samba_bin/sbatch" \
            "${SAMBA_PATH}/samba_bin/scancel" \
            "${SAMBA_PATH}/samba_bin/scontrol" \
            "${SAMBA_PATH}/samba_bin/squeue" \
            "${SAMBA_ROOT}/bin/"
    else
        echo "[final] WARNING: samba_bin folder not found under ${SAMBA_PATH}" >&2
    fi

    # Scheduler proxy scripts (samba_sched_sacct, samba_sched_sbatch, etc.)
    if [ -d "${SAMBA_PATH}/samba_sched_wrappers" ]; then
        cp -f \
            "${SAMBA_PATH}/samba_sched_wrappers/samba_sched_sacct" \
            "${SAMBA_PATH}/samba_sched_wrappers/samba_sched_sbatch" \
            "${SAMBA_PATH}/samba_sched_wrappers/samba_sched_scancel" \
            "${SAMBA_PATH}/samba_sched_wrappers/samba_sched_scontrol" \
            "${SAMBA_PATH}/samba_sched_wrappers/samba_sched_squeue" \
            "${SAMBA_ROOT}/bin/"
    else
        echo "[final] WARNING: samba_sched_wrappers folder not found under ${SAMBA_PATH}" >&2
    fi

    chmod -R a+rx "${SAMBA_ROOT}/bin"

    echo "[final] done: SAMBA + wrappers installed."

%runscript
    # Default entrypoint: run the SAMBA startup script.
    # You can override this by explicitly calling 'singularity exec ... SAMBA_startup ...'
    if [ -x /opt/samba/SAMBA/SAMBA_startup ]; then
        exec /opt/samba/SAMBA/SAMBA_startup "$@"
    else
        echo "ERROR: /opt/samba/SAMBA/SAMBA_startup not found or not executable." >&2
        echo "You probably want to exec into the container and diagnose:" >&2
        echo "  singularity exec samba.sif bash" >&2
        exit 1
    fi

%test
    # Non-fatal sanity checks â€” these should NEVER break the build.
    set -eu

    echo "[test] checking basic tools in PATH inside final image..."

    echo "[test] which perl:"
    command -v perl || echo "[test] WARNING: perl not found in PATH"

    echo "[test] which fslmaths:"
    if command -v fslmaths >/dev/null 2>&1; then
        # Do not fail if this errors; just warn.
        if ! fslmaths -version >/dev/null 2>&1; then
            echo "[test] WARNING: fslmaths -version failed (but continuing)."
        fi
    else
        echo "[test] WARNING: fslmaths not found in PATH"
    fi

    echo "[test] checking SAMBA location..."
    if [ -d /opt/samba/SAMBA ]; then
        ls -d /opt/samba/SAMBA || true
    else
        echo "[test] WARNING: /opt/samba/SAMBA missing" >&2
    fi

    echo "[test] checking atlas presence (non-fatal)..."
    if [ -d /opt/atlases/chass_symmetric3 ]; then
        ls /opt/atlases/chass_symmetric3 | head -10 || true
    else
        echo "[test] WARNING: default atlas /opt/atlases/chass_symmetric3 not present in image." >&2
        echo "[test]          You can still bind an external atlas via ATLAS_FOLDER at runtime." >&2
    fi

    echo "[test] final stage checks complete (non-fatal)."
    exit 0
