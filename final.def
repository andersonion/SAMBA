Bootstrap: localimage
From: fsl_mcr.sif

%labels
    Stage: final
    Maintainer: BJ Anderson + ChatGPT (final stage: SAMBA + atlas + scheduler proxy)

%environment
    source /opt/env/samba.sh

%post
    set -eu

    # Ensure canonical env file exists
    mkdir -p /opt/env
    [ -f /opt/env/samba.sh ] || { echo "FATAL: /opt/env/samba.sh missing" >&2; exit 1; }

    # --------------------------------------------------------------
    # FINAL-stage runtime env (single canonical file; no redundancy)
    #   - SAMBA_APPS_DIR is the one true root (non-overridable)
    #   - Everything else cascades from it
    #   - ATLAS_FOLDER + SAMBA_CACHE_DIR are allowed to be overridden
    # --------------------------------------------------------------
    if ! grep -q 'FINAL (stage: final)' /opt/env/samba.sh; then
        cat << 'EOF' >> /opt/env/samba.sh

# ---- FINAL (stage: final) ----

# Canonical root for everything SAMBA inside the image (do not override)
export SAMBA_APPS_DIR=/opt/samba

# Cascading paths
export SAMBA_PATH="${SAMBA_APPS_DIR}/SAMBA"
export PERL_LOCAL_LIB_ROOT="${SAMBA_APPS_DIR}/perl5libs"
export MATLAB_EXEC_ROOT="${SAMBA_APPS_DIR}/matlab_execs_for_SAMBA"

# Atlas folder is overrideable by launcher (host bind -> /atlas_host)
export ATLAS_FOLDER="${ATLAS_FOLDER:-/opt/atlases}"
export SAMBA_ATLAS_DIR="${SAMBA_ATLAS_DIR:-${ATLAS_FOLDER}/chass_symmetric3}"

# Cache dir should be overrideable (per your requirement)
export SAMBA_CACHE_DIR="${SAMBA_CACHE_DIR:-/opt/zenodo_cache}"

# Perl env
export PERL5LIB="${PERL_LOCAL_LIB_ROOT}/lib/perl5"
export PERL_MB_OPT="--install_base \"${PERL_LOCAL_LIB_ROOT}\""
export PERL_MM_OPT="INSTALL_BASE=${PERL_LOCAL_LIB_ROOT}"

# PATH: keep variable form
export PATH="${SAMBA_APPS_DIR}/bin:${PERL_LOCAL_LIB_ROOT}/bin:${SAMBA_APPS_DIR}/perl5/bin:${SAMBA_PATH}:${PATH}"
EOF
    fi

    # Make it available during build as well
    . /opt/env/samba.sh

    # --------------------------------------------------------------
    # Vars (build-time only)
    # --------------------------------------------------------------
    ZENODO_ID="15178373"

    # Ensure key dirs exist
    mkdir -p /opt/src \
             "${SAMBA_APPS_DIR}" \
             "${SAMBA_APPS_DIR}/bin" \
             "${SAMBA_APPS_DIR}/perl5" \
             "${PERL_LOCAL_LIB_ROOT}" \
             "${ATLAS_FOLDER}" \
             "${SAMBA_CACHE_DIR}"

    chmod 0755 "${SAMBA_APPS_DIR}"

    echo "[final] starting final stage..."
    echo "[final] SAMBA_APPS_DIR=${SAMBA_APPS_DIR}"
    echo "[final] SAMBA_PATH=${SAMBA_PATH}"
    echo "[final] ATLAS_FOLDER=${ATLAS_FOLDER}"
    echo "[final] SAMBA_ATLAS_DIR=${SAMBA_ATLAS_DIR}"
    echo "[final] SAMBA_CACHE_DIR=${SAMBA_CACHE_DIR}"

    # --------------------------------------------------------------
    # Helpers (POSIX sh safe)
    # --------------------------------------------------------------
    _sysrun() {
        env -i \
            PATH=/usr/sbin:/usr/bin:/sbin:/bin \
            LC_ALL=C \
            DEBIAN_FRONTEND=noninteractive \
            LD_LIBRARY_PATH=/usr/lib/x86_64-linux-gnu:/lib/x86_64-linux-gnu \
            "$@"
    }

    _mcr_shield_begin() {
        if [ -f /etc/ld.so.conf.d/mcr_v90.conf ]; then
            mv /etc/ld.so.conf.d/mcr_v90.conf /etc/ld.so.conf.d/mcr_v90.conf.disabled
            ldconfig
            : > /tmp/.mcr_shielded
            echo "[final] MCR shield ON"
        fi
    }

    _mcr_shield_end() {
        if [ -f /tmp/.mcr_shielded ]; then
            mv /etc/ld.so.conf.d/mcr_v90.conf.disabled /etc/ld.so.conf.d/mcr_v90.conf
            ldconfig
            rm -f /tmp/.mcr_shielded
            echo "[final] MCR shield OFF"
        fi
    }

    # Always curl with system libs; call only while shielded.
    syscurl() {
        env -i \
            PATH=/usr/sbin:/usr/bin:/sbin:/bin \
            LD_LIBRARY_PATH=/usr/lib/x86_64-linux-gnu:/lib/x86_64-linux-gnu \
            /usr/bin/curl "$@"
    }

    # --------------------------------------------------------------
    # System deps
    #   - shield MCR so apt/curl/cpanm see system libs
    #   - add X libs + ncurses5 for MCR deployed apps
    # --------------------------------------------------------------
    _mcr_shield_begin
    echo "[final] installing base tools..."
    _sysrun apt-get update
    _sysrun apt-get install -y --no-install-recommends \
        git rsync ca-certificates curl unzip \
        make gcc perl-modules cpanminus python3 \
        libncurses5 \
        libx11-6 libxext6 libxrender1 libxt6 libxmu6 libxi6
    _sysrun apt-get clean
    _sysrun rm -rf /var/lib/apt/lists/*
    _mcr_shield_end

    # --------------------------------------------------------------
    # Fetch & stage SAMBA
    # --------------------------------------------------------------
    echo "[final] fetching SAMBA repo..."
    if [ ! -d /opt/src/SAMBA ]; then
        git clone https://github.com/andersonion/SAMBA.git /opt/src/SAMBA
    fi
    git -C /opt/src/SAMBA fetch --all --tags --prune

    SAMBA_REF="${SAMBA_REF:-master}"
    if git -C /opt/src/SAMBA show-ref --verify --quiet "refs/remotes/origin/${SAMBA_REF}"; then
        git -C /opt/src/SAMBA checkout -f -B buildpin "origin/${SAMBA_REF}"
    else
        echo "FATAL: SAMBA_REF '${SAMBA_REF}' not found on origin." >&2
        exit 1
    fi

    echo "[final] installing SAMBA into ${SAMBA_PATH}..."
    rm -rf "${SAMBA_PATH}.tmp"
    rsync -a --delete /opt/src/SAMBA/ "${SAMBA_PATH}.tmp"/
    mv -f "${SAMBA_PATH}.tmp" "${SAMBA_PATH}"
    chmod -R a+rX "${SAMBA_PATH}"

    # --------------------------------------------------------------
    # Perl toolchain + Carton (baked in)
    # --------------------------------------------------------------
    _mcr_shield_begin
    echo "[final] ensuring cpanm..."
    if ! command -v cpanm >/dev/null 2>&1; then
        echo "[final] cpanm missing after apt; bootstrapping..."
        syscurl -fsSL https://cpanmin.us | perl - App::cpanminus
    fi

    echo "[final] installing local::lib + Carton..."
    cpanm --quiet --notest --local-lib="${PERL_LOCAL_LIB_ROOT}" local::lib Carton
    _mcr_shield_end

    CARTON_BIN="${PERL_LOCAL_LIB_ROOT}/bin/carton"
    if [ ! -x "${CARTON_BIN}" ]; then
        echo "FATAL: ${CARTON_BIN} missing after Carton install" >&2
        exit 1
    fi

    cd "${SAMBA_PATH}"
    echo "[carton] warm install to generate cpanfile.snapshot..."
    env -i \
        PATH="${PERL_LOCAL_LIB_ROOT}/bin:/usr/sbin:/usr/bin:/sbin:/bin" \
        LC_ALL=C \
        DEBIAN_FRONTEND=noninteractive \
        LD_LIBRARY_PATH="/usr/lib/x86_64-linux-gnu:/lib/x86_64-linux-gnu" \
        PERL5LIB="${PERL_LOCAL_LIB_ROOT}/lib/perl5" \
        "${CARTON_BIN}" install --path "${PERL_LOCAL_LIB_ROOT}"

    if [ -f "cpanfile.snapshot" ]; then
        echo "[carton] snapshot present; locking with --deployment..."
        env -i \
            PATH="${PERL_LOCAL_LIB_ROOT}/bin:/usr/sbin:/usr/bin:/sbin:/bin" \
            LC_ALL=C \
            DEBIAN_FRONTEND=noninteractive \
            LD_LIBRARY_PATH="/usr/lib/x86_64-linux-gnu:/lib/x86_64-linux-gnu" \
            PERL5LIB="${PERL_LOCAL_LIB_ROOT}/lib/perl5" \
            "${CARTON_BIN}" install --deployment --path "${PERL_LOCAL_LIB_ROOT}"
    else
        echo "[carton] WARNING: no cpanfile.snapshot created; leaving warm install as-is."
    fi
    echo "[carton] done."

    # --------------------------------------------------------------
    # matlab_execs_for_SAMBA runtime repo + compatibility symlink
    # --------------------------------------------------------------
    if [ ! -d "${MATLAB_EXEC_ROOT}" ]; then
        git clone https://github.com/andersonion/matlab_execs_for_SAMBA.git "${MATLAB_EXEC_ROOT}"
    fi
    chmod -R a+rX "${MATLAB_EXEC_ROOT}"
    ln -sfn "${MATLAB_EXEC_ROOT}" /opt/matlab_execs

    # ==============================================================
    # MATLAB deployed execs: enforce "no baked *_mcr dirs" policy
    #   - Remove any existing *_mcr directories created during build
    #   - Replace with symlinks pointing into /tmp/mcr_ctf/<exe>_mcr
    # ==============================================================
    echo "[final] enforcing *_mcr symlink policy for MATLAB execs..."

    # Ensure /tmp exists and is sticky (runtime expectation)
    mkdir -p /tmp/mcr_ctf
    chmod 1777 /tmp || true

    # 1) Nuke any baked *_mcr *directories* inside the repo tree (they break runtime)
    find /opt/samba/matlab_execs_for_SAMBA -type d -name '*_mcr' -prune -exec rm -rf {} + 2>/dev/null || true

    # 2) Remove any existing *_mcr symlinks (we'll recreate cleanly)
    find /opt/samba/matlab_execs_for_SAMBA -type l -name '*_mcr' -exec rm -f {} + 2>/dev/null || true

    # 3) Recreate symlinks next to each deployed executable
    find /opt/samba/matlab_execs_for_SAMBA -type f -name 'run_*.sh' 2>/dev/null \
      | while IFS= read -r wrap; do
            d="$(dirname "$wrap")"

            find "$d" -maxdepth 1 -type f -perm -111 2>/dev/null \
              | while IFS= read -r exe; do
                    b="$(basename "$exe")"
                    case "$b" in
                        run_*.sh) continue ;;
                        *.ctf)    continue ;;
                    esac
                    ln -sfn "/tmp/mcr_ctf/${b}_mcr" "${d}/${b}_mcr"
                done
        done


    # --------------------------------------------------------------
    # Embed Atlas from Zenodo (final stage; fatal if missing)
    # --------------------------------------------------------------
    echo "[atlas] embedding atlas from Zenodo record ${ZENODO_ID}..."
    mkdir -p "${ATLAS_FOLDER}" "${SAMBA_ATLAS_DIR}"
    cd "${ATLAS_FOLDER}"

    TMP_JSON="/tmp/zenodo_${ZENODO_ID}.json"
    _mcr_shield_begin
    syscurl -fsSL "https://zenodo.org/api/records/${ZENODO_ID}" -o "${TMP_JSON}"
    _mcr_shield_end

    TARBALL_NAME="$(
        python3 - "$TMP_JSON" <<'PY'
import json,sys
j=json.load(open(sys.argv[1]))
files=j.get("files",[])
t=[f["key"] for f in files if f["key"].endswith(".tar.gz")]
print(t[0] if t else "")
PY
    )"

    if [ -n "${TARBALL_NAME}" ]; then
        echo "[atlas] fetching tarball: ${TARBALL_NAME}"
        _mcr_shield_begin
        syscurl -fL --retry 4 --retry-delay 2 \
            -o "${TARBALL_NAME}" \
            "https://zenodo.org/api/records/${ZENODO_ID}/files/${TARBALL_NAME}/content"
        _mcr_shield_end
        tar -xzf "${TARBALL_NAME}" -C "${ATLAS_FOLDER}"
        rm -f "${TARBALL_NAME}"
    else
        echo "[atlas] no tarball; fetching individual files."
        req="chass_symmetric3_DWI.nii.gz chass_symmetric3_FA.nii.gz chass_symmetric3_labels.nii.gz chass_symmetric3_labels_lookup.txt chass_symmetric3_mask.nii.gz chass_symmetric3_MD.nii.gz chass_symmetric3_MO.nii.gz chass_symmetric3_T2.nii.gz"
        for k in $req; do
            echo "  [atlas] fetching ${k} ..."
            _mcr_shield_begin
            syscurl -fL --retry 4 --retry-delay 2 \
                -o "${SAMBA_ATLAS_DIR}/${k}" \
                "https://zenodo.org/api/records/${ZENODO_ID}/files/${k}/content"
            _mcr_shield_end
        done
    fi

    if [ ! -d "${SAMBA_ATLAS_DIR}" ]; then
        echo "FATAL: atlas directory missing after download: ${SAMBA_ATLAS_DIR}" >&2
        exit 1
    fi
    chmod -R a+rX "${ATLAS_FOLDER}"
    echo "[final] atlas embedded at ${SAMBA_ATLAS_DIR}"

    # --------------------------------------------------------------
    # Install SAMBA helper binaries and scheduler wrappers
    # --------------------------------------------------------------
    echo "[final] installing SAMBA helper binaries and scheduler wrappers..."
    mkdir -p "${SAMBA_APPS_DIR}/bin"

    if [ ! -d "${SAMBA_PATH}/samba_bin" ]; then
        echo "FATAL: ${SAMBA_PATH}/samba_bin not found." >&2
        exit 1
    fi
    if [ ! -d "${SAMBA_PATH}/samba_sched_wrappers" ]; then
        echo "FATAL: ${SAMBA_PATH}/samba_sched_wrappers not found." >&2
        exit 1
    fi

    cp -f \
        "${SAMBA_PATH}/samba_bin/sbatch" \
        "${SAMBA_PATH}/samba_bin/squeue" \
        "${SAMBA_PATH}/samba_bin/scancel" \
        "${SAMBA_PATH}/samba_bin/sacct" \
        "${SAMBA_PATH}/samba_bin/scontrol" \
        "${SAMBA_APPS_DIR}/bin/"

    cp -f \
        "${SAMBA_PATH}/samba_sched_wrappers/samba_sched_sbatch" \
        "${SAMBA_PATH}/samba_sched_wrappers/samba_sched_squeue" \
        "${SAMBA_PATH}/samba_sched_wrappers/samba_sched_scancel" \
        "${SAMBA_PATH}/samba_sched_wrappers/samba_sched_sacct" \
        "${SAMBA_PATH}/samba_sched_wrappers/samba_sched_scontrol" \
        "${SAMBA_APPS_DIR}/bin/"

    if [ -f "${SAMBA_PATH}/samba_sched_wrappers/samba_sched_proxy" ]; then
        cp -f "${SAMBA_PATH}/samba_sched_wrappers/samba_sched_proxy" "${SAMBA_APPS_DIR}/bin/"
    elif [ -f "${SAMBA_PATH}/samba_bin/samba_sched_proxy" ]; then
        cp -f "${SAMBA_PATH}/samba_bin/samba_sched_proxy" "${SAMBA_APPS_DIR}/bin/"
    else
        echo "FATAL: samba_sched_proxy not found in repo." >&2
        exit 1
    fi

    chmod -R a+rx "${SAMBA_APPS_DIR}/bin"
    echo "[final] done: SAMBA + atlas + wrappers installed."

%test
    set -eu

    echo "[test] === final stage sanity checks ==="

    echo "[test] checking SAMBA_PATH..."
    if [ ! -d "/opt/samba/SAMBA" ]; then
        echo "FATAL: SAMBA_PATH missing: /opt/samba/SAMBA" >&2
        exit 1
    fi
    echo "  OK: SAMBA_PATH exists."

    echo "[test] checking atlas at: /opt/atlases/chass_symmetric3"
    if [ ! -d "/opt/atlases/chass_symmetric3" ]; then
        echo "FATAL: atlas directory not found: /opt/atlases/chass_symmetric3" >&2
        exit 1
    fi
    for f in \
        chass_symmetric3_FA.nii.gz \
        chass_symmetric3_DWI.nii.gz \
        chass_symmetric3_labels.nii.gz \
        chass_symmetric3_mask.nii.gz
    do
        if [ ! -f "/opt/atlases/chass_symmetric3/${f}" ]; then
            echo "FATAL: missing atlas file: /opt/atlases/chass_symmetric3/${f}" >&2
            exit 1
        fi
        echo "  OK: ${f}"
    done

    echo "[test] checking scheduler helpers in /opt/samba/bin..."
    for c in \
        sbatch squeue scancel sacct scontrol \
        samba_sched_sbatch samba_sched_squeue samba_sched_scancel samba_sched_sacct samba_sched_scontrol \
        samba_sched_proxy
    do
        if [ ! -x "/opt/samba/bin/${c}" ]; then
            echo "FATAL: missing required scheduler helper: /opt/samba/bin/${c}" >&2
            exit 1
        fi
        echo "  OK: ${c}"
    done

    echo "[test] checking MATLAB exec *_mcr symlink policy..."

    # Fail ONLY if there are *_mcr directories
    if find /opt/samba/matlab_execs_for_SAMBA -type d -name '*_mcr' -print -quit 2>/dev/null | grep -q .; then
        echo "FATAL: found baked *_mcr directory under matlab_execs_for_SAMBA" >&2
        find /opt/samba/matlab_execs_for_SAMBA -type d -name '*_mcr' -print 2>/dev/null | head -n 50 >&2
        exit 1
    fi

    # If any *_mcr exist, they MUST be symlinks pointing into /tmp/mcr_ctf
    bad=0
    find /opt/samba/matlab_execs_for_SAMBA -name '*_mcr' -print 2>/dev/null \
      | while IFS= read -r p; do
            # skip empty lines defensively
            [ -n "$p" ] || continue

            if [ ! -L "$p" ]; then
                echo "FATAL: *_mcr exists but is not a symlink: $p" >&2
                bad=1
                continue
            fi

            t="$(readlink "$p" 2>/dev/null || true)"
            case "$t" in
                /tmp/mcr_ctf/*_mcr) : ;;
                *)
                    echo "FATAL: *_mcr symlink does not point into /tmp/mcr_ctf: $p -> $t" >&2
                    bad=1
                    ;;
            esac
        done

    # NOTE: the while-loop above runs in a subshell in POSIX sh when fed by a pipe,
    # so we can't reliably read "bad" afterwards. Instead, do a second hard check:
    if find /opt/samba/matlab_execs_for_SAMBA -name '*_mcr' -type l -print 2>/dev/null \
      | while IFS= read -r p; do
            t="$(readlink "$p" 2>/dev/null || true)"
            case "$t" in /tmp/mcr_ctf/*_mcr) exit 0 ;; esac
            exit 1
        done
    then
        : # at least one symlink points correctly (not a proof all do)
    fi

    # Stronger "all must match" check without relying on shell vars:
    if find /opt/samba/matlab_execs_for_SAMBA -name '*_mcr' -type l -print 2>/dev/null \
      | while IFS= read -r p; do
            t="$(readlink "$p" 2>/dev/null || true)"
            case "$t" in /tmp/mcr_ctf/*_mcr) : ;; *) exit 1 ;; esac
        done
    then
        echo "[test] MATLAB *_mcr symlink policy OK"
    else
        echo "FATAL: one or more *_mcr symlinks do not target /tmp/mcr_ctf" >&2
        find /opt/samba/matlab_execs_for_SAMBA -name '*_mcr' -print 2>/dev/null | head -n 50 >&2
        exit 1
    fi


    echo "[test] final stage checks COMPLETE."

%runscript
    exec /bin/sh -c "$@"
