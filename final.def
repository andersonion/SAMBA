Bootstrap: localimage
From: fsl_mcr.sif

%labels
    Author      BJ Anderson
    Application SAMBA
    Stage       final

%post
#!/bin/sh
set -eu

echo "[final] === starting final stage setup ==="

# Core locations
SAMBA_ROOT=/opt/samba
SAMBA_PATH=/opt/samba/SAMBA
ATLAS_ROOT=/opt/atlases
ATLAS_SUBDIR=chass_symmetric3
SAMBA_ATLAS_DIR="${ATLAS_ROOT}/${ATLAS_SUBDIR}"

# Basic directories (do NOT touch MCR or FSL here)
mkdir -p /opt/src "${SAMBA_ROOT}" "${ATLAS_ROOT}" /opt/zenodo_cache

###############################################################################
# 1) Install / refresh SAMBA code under /opt/samba/SAMBA
###############################################################################
echo "[final] installing SAMBA into ${SAMBA_PATH}..."

if [ ! -d /opt/src/SAMBA ]; then
    git clone https://github.com/andersonion/SAMBA.git /opt/src/SAMBA
else
    # Refresh remote refs but don't explode if this fails
    git -C /opt/src/SAMBA fetch --all --tags --prune || true
fi

SAMBA_REF=master
if git -C /opt/src/SAMBA show-ref --verify --quiet refs/remotes/origin/master; then
    git -C /opt/src/SAMBA checkout -f -B buildpin origin/master
else
    # Fallback if remote branch resolution ever changes
    git -C /opt/src/SAMBA checkout -f -B buildpin "${SAMBA_REF}"
fi

rm -rf "${SAMBA_PATH}.tmp"
rsync -a --delete /opt/src/SAMBA/ "${SAMBA_PATH}.tmp"/
mv -f "${SAMBA_PATH}.tmp" "${SAMBA_PATH}"
chmod -R a+rX "${SAMBA_PATH}"

echo "[final] SAMBA installed at ${SAMBA_PATH}"

###############################################################################
# 2) Install SAMBA helper binaries + scheduler wrappers into /opt/samba/bin
###############################################################################
echo "[final] installing SAMBA helper binaries and scheduler wrappers..."

mkdir -p "${SAMBA_ROOT}/bin"

# Plain helper shims (sacct, sbatch, etc.)
if [ -d "${SAMBA_PATH}/samba_bin" ]; then
    cp -f "${SAMBA_PATH}"/samba_bin/* "${SAMBA_ROOT}/bin"/
fi

# Scheduler proxy binaries (samba_sched_*)
if [ -d "${SAMBA_PATH}/samba_sched_wrappers" ]; then
    cp -f "${SAMBA_PATH}"/samba_sched_wrappers/* "${SAMBA_ROOT}/bin"/
fi

chmod -R a+rx "${SAMBA_ROOT}/bin"
echo "[final] SAMBA helper binaries + wrappers installed under ${SAMBA_ROOT}/bin"

###############################################################################
# 3) Install chass_symmetric3 atlas from Zenodo into /opt/atlases/chass_symmetric3
###############################################################################
echo "[final] installing chass_symmetric3 atlas into ${SAMBA_ATLAS_DIR}..."

if [ ! -d "${SAMBA_ATLAS_DIR}" ]; then
    mkdir -p "${SAMBA_ATLAS_DIR}"
    cd "${SAMBA_ATLAS_DIR}"

    AZ_ID=15178373
    BASE_URL="https://zenodo.org/api/records/${AZ_ID}/files"

    # Explicit list so we don't rely on JSON parsing in this stage
    FILES="
        chass_symmetric3_DWI.nii.gz
        chass_symmetric3_FA.nii.gz
        chass_symmetric3_MD.nii.gz
        chass_symmetric3_MO.nii.gz
        chass_symmetric3_T2.nii.gz
        chass_symmetric3_labels.nii.gz
        chass_symmetric3_labels_lookup.txt
        chass_symmetric3_mask.nii.gz
    "

    for f in ${FILES}; do
        f_trim=$(printf "%s" "${f}" | tr -d '[:space:]')
        [ -z "${f_trim}" ] && continue
        echo "  [atlas] fetching ${f_trim} ..."
        # Use clean env so MATLAB's libcurl/libstdc++ don't poison curl
        env -i PATH=/usr/sbin:/usr/bin:/sbin:/bin LD_LIBRARY_PATH= \
            /usr/bin/curl -fsSL \
            "${BASE_URL}/${f_trim}/content" \
            -o "${f_trim}"
    done

    chmod -R a+rX "${ATLAS_ROOT}"
else
    echo "[final] atlas directory already present; not re-downloading."
fi

echo "[final] done: SAMBA + atlas + wrappers installed."
echo "[final] === end of final stage setup ==="

%environment
# Core SAMBA paths
export SAMBA_ROOT=/opt/samba
export SAMBA_PATH=/opt/samba/SAMBA
export SAMBA_ATLAS_DIR=/opt/atlases/chass_symmetric3

# Perl libraries (installed in earlier stages, e.g., fsl_mcr.sif)
export PERL5LIB=/opt/samba/perl5libs/lib/perl5${PERL5LIB:+:${PERL5LIB}}

# Make sure SAMBA helper binaries + sched wrappers come first
export PATH=/opt/samba/bin:/opt/samba/perl5libs/bin:/opt/samba/perl5/bin:$PATH

%runscript
# Default entrypoint: just chain to SAMBA_startup inside the container.
exec /opt/samba/SAMBA/SAMBA_startup "$@"

%test
#!/bin/sh
set -eu

echo "[test] === final stage sanity checks ==="

# 1) SAMBA_PATH must exist
SAMBA_PATH="${SAMBA_PATH:-/opt/samba/SAMBA}"
echo "[test] checking SAMBA_PATH at: ${SAMBA_PATH}"
if [ ! -d "${SAMBA_PATH}" ]; then
    echo "FATAL: SAMBA_PATH missing: ${SAMBA_PATH}"
    exit 1
fi
echo "  OK: SAMBA_PATH exists."

# 2) Atlas directory + key files (FATAL if missing)
ATLAS_DIR="${SAMBA_ATLAS_DIR:-/opt/atlases/chass_symmetric3}"
echo "[test] checking atlas at: ${ATLAS_DIR}"

if [ ! -d "${ATLAS_DIR}" ]; then
    echo "FATAL: atlas directory not found: ${ATLAS_DIR}"
    exit 1
fi

REQUIRED_FILES="
    chass_symmetric3_FA.nii.gz
    chass_symmetric3_DWI.nii.gz
    chass_symmetric3_labels.nii.gz
    chass_symmetric3_mask.nii.gz
"

for f in ${REQUIRED_FILES}; do
    f_trim=$(printf "%s" "${f}" | tr -d '[:space:]')
    [ -z "${f_trim}" ] && continue
    if [ ! -f "${ATLAS_DIR}/${f_trim}" ]; then
        echo "FATAL: missing atlas file: ${ATLAS_DIR}/${f_trim}"
        exit 1
    fi
done

echo "[test] atlas check passed."
echo "[test] final stage checks passed."
