Bootstrap: localimage
From: fsl_mcr.sif

%labels
    Stage final
    Maintainer "BJ / SAMBA container"

%environment
    # Core SAMBA locations
    export SAMBA_ROOT=/opt/samba
    export SAMBA_PATH=/opt/samba/SAMBA

    # Default atlas location inside the image
    export SAMBA_ATLAS_DIR=${SAMBA_ATLAS_DIR:-/opt/atlases/chass_symmetric3}

    # Add SAMBA bin + tools
    export PATH="/opt/samba/bin:/opt/samba/fsl/bin:/opt/samba/ants/bin:$PATH"

%post
    set -eu

    SAMBA_ROOT=/opt/samba
    SAMBA_PATH=/opt/samba/SAMBA

    mkdir -p /opt/src "${SAMBA_ROOT}"

    echo "[final] cloning/refreshing SAMBA repo..."
    if [ ! -d /opt/src/SAMBA ]; then
        git clone https://github.com/andersonion/SAMBA.git /opt/src/SAMBA
    else
        git -C /opt/src/SAMBA fetch --all --tags --prune
    fi

    SAMBA_REF=master
    if git -C /opt/src/SAMBA show-ref --verify --quiet "refs/remotes/origin/${SAMBA_REF}"; then
        git -C /opt/src/SAMBA checkout -f -B buildpin "origin/${SAMBA_REF}"
    else
        echo "FATAL: unable to resolve branch ${SAMBA_REF}" >&2
        exit 1
    fi

    echo "[final] installing SAMBA into ${SAMBA_PATH}..."
    rm -rf "${SAMBA_PATH}.tmp"
    rsync -a --delete /opt/src/SAMBA/ "${SAMBA_PATH}.tmp"/
    mv -f "${SAMBA_PATH}.tmp" "${SAMBA_PATH}"
    chmod -R a+rX "${SAMBA_PATH}"

    echo "[final] installing SAMBA helper binaries + scheduler wrappers..."
    mkdir -p /opt/samba/bin

    # --- helper binaries ---
    if [ -d "${SAMBA_PATH}/samba_bin" ]; then
        cp -f ${SAMBA_PATH}/samba_bin/* /opt/samba/bin/
    else
        echo "FATAL: missing directory ${SAMBA_PATH}/samba_bin" >&2
        exit 1
    fi

    # --- scheduler wrappers ---
    if [ -d "${SAMBA_PATH}/samba_sched_wrappers" ]; then
        cp -f ${SAMBA_PATH}/samba_sched_wrappers/* /opt/samba/bin/
    else
        echo "FATAL: missing directory ${SAMBA_PATH}/samba_sched_wrappers" >&2
        exit 1
    fi

    chmod -R a+rx /opt/samba/bin

    echo "[final] done: SAMBA + wrappers installed."

%runscript
    exec /bin/bash "$@"

%test
    set -eu
    echo "[test] === final stage sanity checks ==="

    echo
    echo "[test] checking SAMBA_PATH..."
    if [ -d "${SAMBA_PATH:-/opt/samba/SAMBA}" ]; then
        echo "  OK: SAMBA_PATH exists."
    else
        echo "FATAL: SAMBA_PATH missing." >&2
        exit 1
    fi

    echo
    ATLAS_DIR="${SAMBA_ATLAS_DIR:-/opt/atlases/chass_symmetric3}"
    echo "[test] checking atlas at: ${ATLAS_DIR}"

    if [ ! -d "${ATLAS_DIR}" ]; then
        echo "FATAL: atlas directory not found: ${ATLAS_DIR}" >&2
        exit 1
    fi

    REQUIRED_ATLAS_FILES="
chass_symmetric3_FA.nii.gz
chass_symmetric3_DWI.nii.gz
"

    missing=0
    for f in ${REQUIRED_ATLAS_FILES}; do
        if [ ! -f "${ATLAS_DIR}/${f}" ]; then
            echo "FATAL: missing required atlas file: ${ATLAS_DIR}/${f}" >&2
            missing=1
        fi
    done

    if [ "${missing}" -ne 0 ]; then
        echo "FATAL: atlas validation failed." >&2
        exit 1
    fi

    echo
    echo "[test] final.def sanity checks PASSED (SAMBA + atlas OK)."
