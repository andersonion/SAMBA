Bootstrap: localimage
From: fsl_mcr.sif

%labels
    Stage "final"
    Maintainer "you"

%environment
    # Core paths
    export SAMBA_ROOT="/opt/samba"
    export SAMBA_PATH="${SAMBA_ROOT}/SAMBA"

    # Perl user lib (installed in %post)
    export PERL_LOCAL_LIB_ROOT="${SAMBA_ROOT}/perl5libs"
    export PERL_MB_OPT="--install_base \"${PERL_LOCAL_LIB_ROOT}\""
    export PERL_MM_OPT="INSTALL_BASE=${PERL_LOCAL_LIB_ROOT}"
    export PERL5LIB="${PERL_LOCAL_LIB_ROOT}/lib/perl5"

    # Binaries
    export PATH="${PERL_LOCAL_LIB_ROOT}/bin:${SAMBA_ROOT}/perl5/bin:${SAMBA_ROOT}/ants/bin:${SAMBA_ROOT}/fsl/bin:${SAMBA_PATH}:${PATH}"

    # FSL defaults
    export FSLDIR="${SAMBA_ROOT}/fsl"
    export FSLOUTPUTTYPE="${FSLOUTPUTTYPE:-NIFTI_GZ}"
    export PATH="${FSLDIR}/bin:${PATH}"

    # Atlas (set at build time; kept here for runtime discoverability)
    export SAMBA_ATLAS_DIR="/opt/atlases/chass_symmetric3"

%post
    set -eu

    # --- build-time defaults (env from %environment is runtime-only) ---
    SAMBA_ROOT="${SAMBA_ROOT:-/opt/samba}"
    SAMBA_PATH="${SAMBA_PATH:-${SAMBA_ROOT}/SAMBA}"

    # perl user lib root used by cpanm below
    PERL_LOCAL_LIB_ROOT="${PERL_LOCAL_LIB_ROOT:-${SAMBA_ROOT}/perl5libs}"
    PERL_MB_OPT="${PERL_MB_OPT:---install_base \"${PERL_LOCAL_LIB_ROOT}\"}"
    PERL_MM_OPT="${PERL_MM_OPT:-INSTALL_BASE=${PERL_LOCAL_LIB_ROOT}}"
    PERL5LIB="${PERL5LIB:-${PERL_LOCAL_LIB_ROOT}/lib/perl5}"

    # prepend bins we expect to exist
    PATH="/opt/samba/perl5libs/bin:/opt/samba/perl5/bin:/opt/samba/ants/bin:/opt/samba/fsl/bin:/opt/samba/SAMBA:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
    export SAMBA_ROOT SAMBA_PATH PERL_LOCAL_LIB_ROOT PERL_MB_OPT PERL_MM_OPT PERL5LIB PATH

    # ---- baseline dirs ----
    mkdir -p /opt/src "${SAMBA_ROOT}" "${SAMBA_ROOT}/perl5" "${SAMBA_ROOT}/perl5libs"

    # ---- packages (lean) ----
    apt-get update
    DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
        git ca-certificates curl build-essential \
        cpanminus \
        libssl-dev zlib1g-dev libexpat1-dev libperl-dev \
        libffi-dev libxml2-dev libxslt1-dev \
        libjpeg-dev libpng-dev libtiff5-dev \
        sed coreutils tar
    apt-get clean
    rm -rf /var/lib/apt/lists/*

    # ---- fetch SAMBA ----
    if [ ! -d /opt/src/SAMBA ]; then
        git clone https://github.com/andersonion/SAMBA.git /opt/src/SAMBA
    else
        git -C /opt/src/SAMBA fetch --all --tags --prune
    fi

    # pin to master (repo uses master)
    REF="master"
    if git -C /opt/src/SAMBA show-ref --verify --quiet "refs/remotes/origin/${REF}"; then
        git -C /opt/src/SAMBA checkout -f -B buildpin "origin/${REF}"
    else
        echo "FATAL: cannot resolve SAMBA ref '${REF}'" >&2
        git -C /opt/src/SAMBA show-ref | sed 's/^/  /' >&2 || true
        exit 1
    fi

    # materialize to /opt/samba/SAMBA (atomic-ish without rsync)
    rm -rf "${SAMBA_PATH}.tmp"
    mkdir -p "${SAMBA_PATH}.tmp"
    ( cd /opt/src/SAMBA && tar -cf - . ) | ( cd "${SAMBA_PATH}.tmp" && tar -xf - )
    chmod -R a+rX "${SAMBA_PATH}.tmp"
    mv -f "${SAMBA_PATH}.tmp" "${SAMBA_PATH}"

    # ---- perl user env (no perlbrew, no carton) ----
    if [ -f "${SAMBA_PATH}/cpanfile" ]; then
        cpanm --quiet --notest --local-lib="${PERL_LOCAL_LIB_ROOT}" local::lib
        ( cd "${SAMBA_PATH}" && \
          cpanm --quiet --notest --local-lib="${PERL_LOCAL_LIB_ROOT}" --installdeps . )
    else
        cpanm --quiet --notest --local-lib="${PERL_LOCAL_LIB_ROOT}" \
            Parallel::ForkManager File::Basename File::Path JSON Try::Tiny
    fi
    mkdir -p "${PERL_LOCAL_LIB_ROOT}/bin"

    # =====================================================================
    # Atlas: Zenodo chass_symmetric3 (cached, extracted to /opt/atlases)
    # =====================================================================
    ATLAS_FOLDER="/opt/atlases"
    AZ_ID="15178373"
    DEST_DIR="${ATLAS_FOLDER}"
    CACHE_DIR="/opt/zenodo_cache"
    SAMBA_ATLAS_DIR="${ATLAS_FOLDER}/chass_symmetric3"

    mkdir -p "${DEST_DIR}" "${CACHE_DIR}"
    cd "${DEST_DIR}"

    # ensure python3 for robust JSON parsing
    if ! command -v python3 >/dev/null 2>&1; then
        apt-get update
        apt-get install -y --no-install-recommends python3-minimal ca-certificates
    fi

    echo "[atlas] resolving file from Zenodo record ${AZ_ID} ..."
    ZJSON="$(curl -fsSL "https://zenodo.org/api/records/${AZ_ID}")" || {
        echo "FATAL: could not fetch Zenodo record JSON for ${AZ_ID}" >&2
        exit 1
    }

    FILE_NAME="$(printf '%s' "${ZJSON}" | python3 - <<'PY'
import sys, json, re
data=json.load(sys.stdin)
cand=None
for f in data.get("files", []):
    k=f.get("key","")
    if re.search(r"^chass_symmetric3.*\.tar\.gz$", k):
        cand=k; break
if not cand:
    for f in data.get("files", []):
        k=f.get("key","")
        if k.endswith(".tar.gz"):
            cand=k; break
if not cand:
    print("")  # empty=fail in shell
else:
    print(cand)
PY
    )"

    if [ -z "${FILE_NAME}" ]; then
        echo "[atlas] available files on record:" >&2
        printf '%s' "${ZJSON}" | python3 - <<'PY' 1>&2
import sys, json
for f in json.load(sys.stdin).get("files", []):
    print(" -", f.get("key"))
PY
        echo "FATAL: no .tar.gz file found on Zenodo record ${AZ_ID}" >&2
        exit 1
    fi

    FILE_URL="$(printf '%s' "${ZJSON}" | python3 - <<'PY'
import sys, json, re
data=json.load(sys.stdin)
target=None
for f in data.get("files", []):
    k=f.get("key","")
    if re.search(r"^chass_symmetric3.*\.tar\.gz$", k):
        target=f; break
if target is None:
    for f in data.get("files", []):
        if f.get("key","").endswith(".tar.gz"):
            target=f; break
if target is None:
    print("")
else:
    print(target.get("links",{}).get("download") or target.get("links",{}).get("self",""))
PY
    )"

    if [ -z "${FILE_URL}" ]; then
        echo "FATAL: could not resolve a download URL for ${FILE_NAME}" >&2
        exit 1
    fi

    echo "[atlas] chosen file: ${FILE_NAME}"
    CACHED_TARBALL="${CACHE_DIR}/${FILE_NAME}"
    if [ -f "${CACHED_TARBALL}" ]; then
        cp -f "${CACHED_TARBALL}" "${FILE_NAME}"
    else
        echo "[atlas] downloading ${FILE_NAME} ..."
        curl -fL --retry 5 --retry-delay 2 -o "${FILE_NAME}" "${FILE_URL}"
        cp -f "${FILE_NAME}" "${CACHE_DIR}/" || true
    fi

    # extract and sanity-check directory (it must produce .../chass_symmetric3)
    tar -xzf "${FILE_NAME}"
    rm -f "${FILE_NAME}"
    if [ ! -d "${SAMBA_ATLAS_DIR}" ]; then
        echo "FATAL: chass_symmetric3 folder not found after extraction" >&2
        echo "[atlas] contents of ${DEST_DIR}:" >&2
        ls -la "${DEST_DIR}" >&2 || true
        exit 1
    fi

    # stable path for SAMBA
    ln -sfn "${SAMBA_ATLAS_DIR}" "/opt/samba/atlas"

    # perms
    chmod -R a+rX "/opt/atlases" "/opt/zenodo_cache"


    # ---- java jre (if present in base) ----
    if [ -d /usr/lib/jvm/java-8-openjdk-amd64/jre ]; then
        mkdir -p "${SAMBA_ROOT}/java"
        cp -a /usr/lib/jvm/java-8-openjdk-amd64/jre "${SAMBA_ROOT}/java" || true
    fi

    # ---- quick diag (non-fatal) ----
    echo "[diag] perl $(perl -V:version | sed 's/version=//')" || true
    ( command -v cpanm && cpanm --version ) >/dev/null 2>&1 || true
    ls -ld "${SAMBA_PATH}" || true
    ls -ld "${SAMBA_ATLAS_DIR}" || true
    ls -l "${SAMBA_ROOT}/atlas" || true

%test
    # dash-compatible: no pipefail
    set -eu

    # SAMBA repo exists
    [ -d "/opt/samba/SAMBA" ] || { echo "FATAL: /opt/samba/SAMBA missing"; exit 1; }

    # Perl local::lib usable
    perl -Mlocal::lib=/opt/samba/perl5libs -e1 || { echo "FATAL: local::lib not usable"; exit 1; }
    perl -MFile::Basename -e1 || { echo "FATAL: File::Basename not available"; exit 1; }
    perl -MFile::Path -e1 || { echo "FATAL: File::Path not available"; exit 1; }

    # FSL present (from base image)
    command -v fslmaths >/dev/null 2>&1 || { echo "FATAL: fslmaths not in PATH"; exit 1; }
    fslmaths -version >/dev/null 2>&1 || true

    # Atlas present and non-empty (basic sanity)
    [ -d "/opt/atlases/chass_symmetric3" ] || { echo "FATAL: atlas dir missing"; exit 1; }
    [ -L "/opt/samba/atlas" ] || { echo "FATAL: /opt/samba/atlas symlink missing"; exit 1; }
    ls -1 /opt/atlases/chass_symmetric3/*.nii* >/dev/null 2>&1 || { echo "FATAL: atlas appears empty"; exit 1; }

%runscript
    #!/bin/sh
    exec /bin/bash "$@"
