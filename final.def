Bootstrap: localimage
From: fsl_mcr.sif

%labels
	Stage "final"
	Maintainer "you"

%environment
	# Core paths
	export SAMBA_ROOT="/opt/samba"
	export SAMBA_PATH="${SAMBA_ROOT}/SAMBA"

	# Perl user lib (installed in %post)
	export PERL_LOCAL_LIB_ROOT="${SAMBA_ROOT}/perl5libs"
	export PERL_MB_OPT="--install_base \"${PERL_LOCAL_LIB_ROOT}\""
	export PERL_MM_OPT="INSTALL_BASE=${PERL_LOCAL_LIB_ROOT}"
	export PERL5LIB="${PERL_LOCAL_LIB_ROOT}/lib/perl5"

	# Binaries
	export PATH="${PERL_LOCAL_LIB_ROOT}/bin:${SAMBA_ROOT}/perl5/bin:${SAMBA_ROOT}/ants/bin:${SAMBA_ROOT}/fsl/bin:${SAMBA_PATH}:${PATH}"

	# FSL defaults (already present from base, kept for clarity)
	export FSLDIR="${SAMBA_ROOT}/fsl"
	export FSLOUTPUTTYPE="${FSLOUTPUTTYPE:-NIFTI_GZ}"
	export PATH="${FSLDIR}/bin:${PATH}"

%post
	set -eu

	# ---- baseline dirs ----
	mkdir -p /opt/src "${SAMBA_ROOT}" "${SAMBA_ROOT}/perl5" "${SAMBA_ROOT}/perl5libs"

	# ---- packages for building perl modules (no perlbrew/carton) ----
	# keep it lean but sufficient for CPAN builds
	apt-get update
	DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
		git ca-certificates curl build-essential \
		cpanminus \
		libssl-dev zlib1g-dev libexpat1-dev libperl-dev \
		libffi-dev libxml2-dev libxslt1-dev \
		libjpeg-dev libpng-dev libtiff5-dev \
		sed coreutils
	apt-get clean
	rm -rf /var/lib/apt/lists/*

	# ---- fetch SAMBA ----
	if [ ! -d /opt/src/SAMBA ]; then
		git clone https://github.com/andersonion/SAMBA.git /opt/src/SAMBA
	else
		git -C /opt/src/SAMBA fetch --all --tags --prune
	fi

	# pin to master (repo uses master, not main)
	REF="master"
	if git -C /opt/src/SAMBA show-ref --verify --quiet "refs/remotes/origin/${REF}"; then
		git -C /opt/src/SAMBA checkout -f -B buildpin "origin/${REF}"
	else
		echo "FATAL: cannot resolve SAMBA ref '${REF}'" >&2
		git -C /opt/src/SAMBA show-ref | sed 's/^/  /' >&2 || true
		exit 1
	fi

	# materialize to /opt/samba/SAMBA (atomic-ish without rsync)
	rm -rf "${SAMBA_PATH}.tmp"
	mkdir -p "${SAMBA_PATH}.tmp"
	# copy tree
	( cd /opt/src/SAMBA && tar -cf - . ) | ( cd "${SAMBA_PATH}.tmp" && tar -xf - )
	chmod -R a+rX "${SAMBA_PATH}.tmp"
	mv -f "${SAMBA_PATH}.tmp" "${SAMBA_PATH}"

	# ---- perl user env (no perlbrew, no carton) ----
	# Install local::lib & project deps from cpanfile (if present)
	if [ -f "${SAMBA_PATH}/cpanfile" ]; then
		# ensure local::lib available
		cpanm --quiet --notest --local-lib="${PERL_LOCAL_LIB_ROOT}" local::lib
		# install deps declared by SAMBA
		( cd "${SAMBA_PATH}" && \
		  cpanm --quiet --notest --local-lib="${PERL_LOCAL_LIB_ROOT}" --installdeps . )
	else
		# fallback: some common modules used in SAMBA stack (kept minimal)
		cpanm --quiet --notest --local-lib="${PERL_LOCAL_LIB_ROOT}" \
			Parallel::ForkManager File::Basename File::Path JSON Try::Tiny
	fi

	# safety: make sure bin dir exists even if no scripts were installed
	mkdir -p "${PERL_LOCAL_LIB_ROOT}/bin"

	# ---- java jre (copied earlier in base; keep if present) ----
	if [ -d /usr/lib/jvm/java-8-openjdk-amd64/jre ]; then
		mkdir -p "${SAMBA_ROOT}/java"
		cp -a /usr/lib/jvm/java-8-openjdk-amd64/jre "${SAMBA_ROOT}/java" || true
	fi

	# ---- quick diag to help later debugging (does not fail build) ----
	echo "[diag] perl $(perl -V:version | sed 's/version=//')" || true
	( command -v cpanm && cpanm --version ) >/dev/null 2>&1 || true
	ls -ld "${SAMBA_PATH}" || true

%test
	# dash-compatible: no pipefail
	set -eu

	# Paths/env sanity
	[ -d "/opt/samba/SAMBA" ] || { echo "FATAL: /opt/samba/SAMBA missing"; exit 1; }

	# Perl can see our local::lib dir
	perl -Mlocal::lib=/opt/samba/perl5libs -e1 || { echo "FATAL: local::lib not usable"; exit 1; }

	# A couple of common modules expected by SAMBA codepaths (soft check)
	perl -MFile::Basename -e1 || { echo "FATAL: File::Basename not available"; exit 1; }
	perl -MFile::Path -e1 || { echo "FATAL: File::Path not available"; exit 1; }

	# FSL presence (should be in PATH from base image)
	command -v fslmaths >/dev/null 2>&1 || { echo "FATAL: fslmaths not in PATH"; exit 1; }
	fslmaths -version >/dev/null 2>&1 || true

	# SAMBA repo exists & is readable
	[ -r "/opt/samba/SAMBA/README.md" ] || true

%runscript
	#!/bin/sh
	exec /bin/bash "$@"
