Bootstrap: localimage
From: fsl_mcr.sif

%labels
    Stage final
    Maintainer "BJ / SAMBA container"

%environment
    # Core SAMBA paths inside the container
    export SAMBA_ROOT=/opt/samba
    export SAMBA_PATH=/opt/samba/SAMBA

    # Perl library setup for Carton-managed deps
    export PERL_LOCAL_LIB_ROOT=/opt/samba/perl5libs
    export PERL_MB_OPT='--install_base "/opt/samba/perl5libs"'
    export PERL_MM_OPT=INSTALL_BASE=/opt/samba/perl5libs
    export PERL5LIB=/opt/samba/perl5libs/lib/perl5

    # Ensure /opt/samba/bin is first on PATH so wrappers win
    export PATH=/opt/samba/bin:/opt/samba/perl5libs/bin:/opt/samba/perl5/bin:/opt/samba/fsl/bin:/opt/samba/ants/bin:$PATH

    # Atlas defaults inside the container
    export ATLAS_FOLDER=/opt/atlases/chass_symmetric3
    export SAMBA_ATLAS_DIR=/opt/atlases/chass_symmetric3

%post
    set -eu

    SAMBA_ROOT=/opt/samba
    SAMBA_PATH=/opt/samba/SAMBA

    mkdir -p /opt/src "$SAMBA_ROOT" /opt/samba/perl5 /opt/samba/perl5libs /opt/atlases /opt/zenodo_cache

    # --------------------------------------------------
    # Clone SAMBA from GitHub
    # --------------------------------------------------
    echo "[final] cloning SAMBA..."
    if [ ! -d /opt/src/SAMBA ]; then
        git clone https://github.com/andersonion/SAMBA.git /opt/src/SAMBA
    fi
    git -C /opt/src/SAMBA fetch --all --tags --prune

    # Pin to origin/master into a build branch
    SAMBA_REF=master
    if git -C /opt/src/SAMBA show-ref --verify --quiet "refs/remotes/origin/${SAMBA_REF}"; then
        git -C /opt/src/SAMBA checkout -f -B buildpin "origin/${SAMBA_REF}"
    else
        echo "FATAL: cannot resolve SAMBA_REF='${SAMBA_REF}' in /opt/src/SAMBA" >&2
        git -C /opt/src/SAMBA show-ref | sed 's/^/  /' >&2
        exit 1
    fi

    # Sync into /opt/samba/SAMBA
    echo "[final] installing SAMBA into ${SAMBA_PATH}..."
    rm -rf "${SAMBA_PATH}.tmp"
    rsync -a --delete /opt/src/SAMBA/ "${SAMBA_PATH}.tmp"/
    mv -f "${SAMBA_PATH}.tmp" "${SAMBA_PATH}"
    chmod -R a+rX "${SAMBA_PATH}"

    # --------------------------------------------------
    # Perl deps: bootstrap cpanm, then local::lib + Carton
    # --------------------------------------------------
    echo "[final] bootstrapping cpanm (App::cpanminus) if needed..."
    if ! command -v cpanm >/dev/null 2>&1; then
        # IMPORTANT: run curl with a scrubbed env so MCR libcurl/libstdc++ don't break it
        env -i PATH=/usr/sbin:/usr/bin:/sbin:/bin LD_LIBRARY_PATH= \
            /usr/bin/curl -fsSL https://cpanmin.us \
            | perl - App::cpanminus
    fi

    echo "[final] installing Perl toolchain (local::lib + Carton)..."
    cpanm --quiet --notest --local-lib=/opt/samba/perl5libs local::lib Carton

    # Carton-managed deps from cpanfile
    echo "[final] running carton install under ${SAMBA_PATH}..."
    cd "${SAMBA_PATH}"
    env \
      PERL_LOCAL_LIB_ROOT=/opt/samba/perl5libs \
      PERL_MB_OPT='--install_base "/opt/samba/perl5libs"' \
      PERL_MM_OPT=INSTALL_BASE=/opt/samba/perl5libs \
      PERL5LIB=/opt/samba/perl5libs/lib/perl5 \
      PATH=/opt/samba/perl5libs/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin \
      carton install

    # Ensure the local lib bin dir exists (for any scripts Carton installs)
    mkdir -p /opt/samba/perl5libs/bin

    # --------------------------------------------------
    # Atlas fetch: Zenodo record 15178373
    # (uses python3 & curl with scrubbed env for curl)
    # --------------------------------------------------
    echo "[final] installing chass_symmetric3 atlas from Zenodo..."
    ATLAS_FOLDER=/opt/atlases
    AZ_ID=15178373
    DEST_DIR="${ATLAS_FOLDER}"
    CACHE_DIR=/opt/zenodo_cache

    mkdir -p "${DEST_DIR}" "${CACHE_DIR}"
    cd "${DEST_DIR}"

    TMP_JSON="/tmp/zenodo_${AZ_ID}.json"
    echo "[atlas] fetching Zenodo record JSON ${AZ_ID} ..."
    env -i PATH=/usr/sbin:/usr/bin:/sbin:/bin LD_LIBRARY_PATH= \
        /usr/bin/curl -fsSL "https://zenodo.org/api/records/${AZ_ID}" -o "${TMP_JSON}"

    python3 << 'EOF'
import json, os, sys, subprocess

json_path = "/tmp/zenodo_15178373.json"
out_dir = "/opt/atlases"
cache_dir = "/opt/zenodo_cache"

with open(json_path, "r") as f:
    rec = json.load(f)

files = rec.get("files", [])
target_prefix = "chass_symmetric3_"

to_fetch = [f for f in files if f.get("key","").startswith(target_prefix)]
if not to_fetch:
    print("FATAL: no chass_symmetric3_* files found in Zenodo JSON", file=sys.stderr)
    sys.exit(1)

os.makedirs(out_dir, exist_ok=True)
os.makedirs(cache_dir, exist_ok=True)

for f in to_fetch:
    key = f["key"]
    url = f["links"]["self"]  # direct content URL
    dest = os.path.join(out_dir, key)
    cache = os.path.join(cache_dir, key)

    if os.path.exists(cache):
        subprocess.check_call(["cp", "-f", cache, dest])
    else:
        print(f"[atlas] downloading {key} ...")
        # Run curl in a scrubbed environment so MATLAB MCR libs don't interfere
        subprocess.check_call([
            "env",
            "-i",
            "PATH=/usr/sbin:/usr/bin:/sbin:/bin",
            "LD_LIBRARY_PATH=",
            "/usr/bin/curl",
            "-fL",
            "-o", dest,
            url,
        ])
        subprocess.check_call(["cp", "-f", dest, cache])

EOF

    # Sanity check: make sure a couple of key atlas files exist
    for f in \
      chass_symmetric3_T2.nii.gz \
      chass_symmetric3_labels.nii.gz \
      chass_symmetric3_labels_lookup.txt \
      chass_symmetric3_mask.nii.gz; do
        if [ ! -f "${DEST_DIR}/${f}" ]; then
            echo "FATAL: atlas file missing: ${DEST_DIR}/${f}" >&2
            exit 1
        fi
    done

    chmod -R a+rX "${DEST_DIR}" /opt/zenodo_cache

    # --------------------------------------------------
    # Install runtime bin + scheduler wrappers
    # (from SAMBA/samba_bin and SAMBA/samba_sched_wrappers)
    # --------------------------------------------------
    echo "[final] installing SAMBA helper binaries and scheduler wrappers..."
    mkdir -p /opt/samba/bin

    # Helper / utility scripts
    if [ -d "${SAMBA_PATH}/samba_bin" ]; then
        cp -f "${SAMBA_PATH}"/samba_bin/* /opt/samba/bin/ || true
    fi

    # Scheduler wrappers (sbatch/squeue/scancel/sacct/scontrol, etc.)
    if [ -d "${SAMBA_PATH}/samba_sched_wrappers" ]; then
        cp -f "${SAMBA_PATH}"/samba_sched_wrappers/* /opt/samba/bin/ || true
    fi

    chmod -R a+rx /opt/samba/bin

    echo "[final] done: SAMBA + atlas + wrappers installed."

%runscript
    # Default container entrypoint: just give an interactive shell.
    # You typically won't rely on this when using samba-pipe, but it is
    # convenient for debugging:
    exec /bin/bash "$@"

%test
    set -eu
    echo "[test] checking atlas..."
    ls -lh /opt/atlases/chass_symmetric3/chass_symmetric3_T2.nii.gz \
           /opt/atlases/chass_symmetric3/chass_symmetric3_labels.nii.gz \
           /opt/atlases/chass_symmetric3/chass_symmetric3_mask.nii.gz

    echo "[test] checking SAMBA bin & wrappers..."
    ls -lh /opt/samba/bin || true

    echo "[test] checking Carton availability..."
    perl -MCarton -e 'print "Carton OK\n"' || {
        echo "FATAL: Carton not available in final image" >&2
        exit 1
    }

    echo "[test] final stage OK."
