Bootstrap: localimage
From: fsl_mcr.sif

%labels
    Stage "final"
    Maintainer "you"

%environment
    # Core paths
    export SAMBA_ROOT="/opt/samba"
    export SAMBA_PATH="${SAMBA_ROOT}/SAMBA"

    # Perl user lib (installed in %post)
    export PERL_LOCAL_LIB_ROOT="${SAMBA_ROOT}/perl5libs"
    export PERL_MB_OPT="--install_base \"${PERL_LOCAL_LIB_ROOT}\""
    export PERL_MM_OPT="INSTALL_BASE=${PERL_LOCAL_LIB_ROOT}"
    export PERL5LIB="${PERL_LOCAL_LIB_ROOT}/lib/perl5"

    # Binaries
    export PATH="${PERL_LOCAL_LIB_ROOT}/bin:${SAMBA_ROOT}/perl5/bin:${SAMBA_ROOT}/ants/bin:${SAMBA_ROOT}/fsl/bin:${SAMBA_PATH}:${PATH}"

    # FSL defaults
    export FSLDIR="${SAMBA_ROOT}/fsl"
    export FSLOUTPUTTYPE="${FSLOUTPUTTYPE:-NIFTI_GZ}"
    export PATH="${FSLDIR}/bin:${PATH}"

    # Atlas (set at build time; kept here for runtime discoverability)
    export SAMBA_ATLAS_DIR="/opt/atlases/chass_symmetric3"

%post
    set -eu

    # --- build-time defaults (env from %environment is runtime-only) ---
    SAMBA_ROOT="${SAMBA_ROOT:-/opt/samba}"
    SAMBA_PATH="${SAMBA_PATH:-${SAMBA_ROOT}/SAMBA}"

    # perl user lib root used by cpanm below
    PERL_LOCAL_LIB_ROOT="${PERL_LOCAL_LIB_ROOT:-${SAMBA_ROOT}/perl5libs}"
    PERL_MB_OPT="${PERL_MB_OPT:---install_base \"${PERL_LOCAL_LIB_ROOT}\"}"
    PERL_MM_OPT="${PERL_MM_OPT:-INSTALL_BASE=${PERL_LOCAL_LIB_ROOT}}"
    PERL5LIB="${PERL5LIB:-${PERL_LOCAL_LIB_ROOT}/lib/perl5}"

    # prepend bins we expect to exist
    PATH="/opt/samba/perl5libs/bin:/opt/samba/perl5/bin:/opt/samba/ants/bin:/opt/samba/fsl/bin:/opt/samba/SAMBA:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
    export SAMBA_ROOT SAMBA_PATH PERL_LOCAL_LIB_ROOT PERL_MB_OPT PERL_MM_OPT PERL5LIB PATH

    # ---- baseline dirs ----
    mkdir -p /opt/src "${SAMBA_ROOT}" "${SAMBA_ROOT}/perl5" "${SAMBA_ROOT}/perl5libs"

    # ---- packages (lean) ----
    apt-get update
    DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
        git ca-certificates curl build-essential \
        cpanminus \
        libssl-dev zlib1g-dev libexpat1-dev libperl-dev \
        libffi-dev libxml2-dev libxslt1-dev \
        libjpeg-dev libpng-dev libtiff5-dev \
        sed coreutils tar
    apt-get clean
    rm -rf /var/lib/apt/lists/*

    # ---- fetch SAMBA ----
    if [ ! -d /opt/src/SAMBA ]; then
        git clone https://github.com/andersonion/SAMBA.git /opt/src/SAMBA
    else
        git -C /opt/src/SAMBA fetch --all --tags --prune
    fi

    # pin to master (repo uses master)
    REF="master"
    if git -C /opt/src/SAMBA show-ref --verify --quiet "refs/remotes/origin/${REF}"; then
        git -C /opt/src/SAMBA checkout -f -B buildpin "origin/${REF}"
    else
        echo "FATAL: cannot resolve SAMBA ref '${REF}'" >&2
        git -C /opt/src/SAMBA show-ref | sed 's/^/  /' >&2 || true
        exit 1
    fi

    # materialize to /opt/samba/SAMBA (atomic-ish without rsync)
    rm -rf "${SAMBA_PATH}.tmp"
    mkdir -p "${SAMBA_PATH}.tmp"
    ( cd /opt/src/SAMBA && tar -cf - . ) | ( cd "${SAMBA_PATH}.tmp" && tar -xf - )
    chmod -R a+rX "${SAMBA_PATH}.tmp"
    mv -f "${SAMBA_PATH}.tmp" "${SAMBA_PATH}"

    # ---- perl user env (no perlbrew, no carton) ----
    if [ -f "${SAMBA_PATH}/cpanfile" ]; then
        cpanm --quiet --notest --local-lib="${PERL_LOCAL_LIB_ROOT}" local::lib
        ( cd "${SAMBA_PATH}" && \
          cpanm --quiet --notest --local-lib="${PERL_LOCAL_LIB_ROOT}" --installdeps . )
    else
        cpanm --quiet --notest --local-lib="${PERL_LOCAL_LIB_ROOT}" \
            Parallel::ForkManager File::Basename File::Path JSON Try::Tiny
    fi
    mkdir -p "${PERL_LOCAL_LIB_ROOT}/bin"

     # =====================================================================
    # Atlas: Zenodo chass_symmetric3 â†’ /opt/atlases/chass_symmetric3
    #   - Reads JSON from stdin (no argv indexing)
    #   - Works under /bin/sh (no bashisms)
    # =====================================================================
    ATLAS_FOLDER="/opt/atlases"
    AZ_ID="15178373"
    DEST_DIR="${ATLAS_FOLDER}"
    CACHE_DIR="/opt/zenodo_cache"
    SAMBA_ATLAS_DIR="${ATLAS_FOLDER}/chass_symmetric3"
    TMP_JSON="/tmp/zenodo_${AZ_ID}.json"

    mkdir -p "${DEST_DIR}" "${CACHE_DIR}"
    cd "${DEST_DIR}"

    # Ensure python3 for JSON parsing (keep it minimal)
    if ! command -v python3 >/dev/null 2>&1; then
        apt-get update
        apt-get install -y --no-install-recommends python3-minimal ca-certificates
    fi

    echo "[atlas] fetching Zenodo record JSON ${AZ_ID} ..."
    curl -fsSL "https://zenodo.org/api/records/${AZ_ID}" -o "${TMP_JSON}" \
        || { echo "FATAL: cannot fetch Zenodo record ${AZ_ID}" >&2; exit 1; }

    # --- Try to find a .tar.gz in the record ---
    TARBALL_NAME="$(
        python3 - <<'PY' < "${TMP_JSON}"
import json, re, sys
j = json.load(sys.stdin)
for f in j.get("files", []):
    k = f.get("key", "")
    if re.search(r"\.tar\.gz$", k):
        print(k)
        break
PY
    )"

    if [ -n "${TARBALL_NAME}" ]; then
        echo "[atlas] found archive: ${TARBALL_NAME}"
        # pull its download URL
        TARBALL_URL="$(
            TARBALL_NAME="${TARBALL_NAME}" python3 - <<'PY' < "${TMP_JSON}"
import os, json, sys
name = os.environ.get("TARBALL_NAME","")
j = json.load(sys.stdin)
for f in j.get("files", []):
    if f.get("key") == name:
        print(f.get("links", {}).get("download") or f.get("links", {}).get("self", ""))
        break
PY
        )"
        [ -n "${TARBALL_URL}" ] || { echo "FATAL: no URL for ${TARBALL_NAME}" >&2; exit 1; }

        CACHED="${CACHE_DIR}/${TARBALL_NAME}"
        if [ -f "${CACHED}" ]; then
            cp -f "${CACHED}" "${TARBALL_NAME}"
        else
            echo "[atlas] downloading archive ..."
            curl -fL --retry 5 --retry-delay 2 -o "${TARBALL_NAME}" "${TARBALL_URL}"
            cp -f "${TARBALL_NAME}" "${CACHE_DIR}/" || true
        fi

        tar -xzf "${TARBALL_NAME}"
        rm -f "${TARBALL_NAME}"
        [ -d "${SAMBA_ATLAS_DIR}" ] || { echo "FATAL: ${SAMBA_ATLAS_DIR} missing after extraction" >&2; exit 1; }

    else
        echo "[atlas] no .tar.gz in record; downloading individual files ..."
        mkdir -p "${SAMBA_ATLAS_DIR}"

        # expected file keys for CHASS symmetric3
        FILE_KEYS="
chass_symmetric3_T2.nii.gz
chass_symmetric3_DWI.nii.gz
chass_symmetric3_FA.nii.gz
chass_symmetric3_MD.nii.gz
chass_symmetric3_MO.nii.gz
chass_symmetric3_labels.nii.gz
chass_symmetric3_labels_lookup.txt
chass_symmetric3_mask.nii.gz
"

        # build TSV: key \t download_url (from stdin JSON)
        python3 - <<'PY' < "${TMP_JSON}" > /tmp/zen_urls.tsv
import json, sys
j = json.load(sys.stdin)
for f in j.get("files", []):
    key = f.get("key", "")
    url = f.get("links", {}).get("download") or f.get("links", {}).get("self", "")
    if key and url:
        print(f"{key}\t{url}")
PY

        # fetch each needed file (use cache if available)
        IFS='
'
        for K in ${FILE_KEYS}; do
            [ -n "${K}" ] || continue
            URL="$(awk -v k="${K}" -F '\t' '$1==k{print $2}' /tmp/zen_urls.tsv | head -1)"
            if [ -z "${URL}" ]; then
                echo "FATAL: ${K} not present on Zenodo record ${AZ_ID}" >&2
                echo "[atlas] available files:" >&2
                cut -f1 /tmp/zen_urls.tsv >&2
                exit 1
            fi
            CACHED="${CACHE_DIR}/${K}"
            if [ -f "${CACHED}" ]; then
                cp -f "${CACHED}" "${SAMBA_ATLAS_DIR}/${K}"
            else
                echo "[atlas] downloading ${K} ..."
                curl -fL --retry 5 --retry-delay 2 -o "${SAMBA_ATLAS_DIR}/${K}" "${URL}"
                cp -f "${SAMBA_ATLAS_DIR}/${K}" "${CACHE_DIR}/" || true
            fi
        done
    fi

    # Stable path for SAMBA + perms
    ln -sfn "${SAMBA_ATLAS_DIR}" "/opt/samba/atlas"
    chmod -R a+rX "/opt/atlases" "/opt/zenodo_cache"
    rm -f "${TMP_JSON}"
    echo "[atlas] ready at /opt/samba/atlas"



    # ---- java jre (if present in base) ----
    if [ -d /usr/lib/jvm/java-8-openjdk-amd64/jre ]; then
        mkdir -p "${SAMBA_ROOT}/java"
        cp -a /usr/lib/jvm/java-8-openjdk-amd64/jre "${SAMBA_ROOT}/java" || true
    fi

    # ---- quick diag (non-fatal) ----
    echo "[diag] perl $(perl -V:version | sed 's/version=//')" || true
    ( command -v cpanm && cpanm --version ) >/dev/null 2>&1 || true
    ls -ld "${SAMBA_PATH}" || true
    ls -ld "${SAMBA_ATLAS_DIR}" || true
    ls -l "${SAMBA_ROOT}/atlas" || true

%test
    # dash-compatible: no pipefail
    set -eu

    # SAMBA repo exists
    [ -d "/opt/samba/SAMBA" ] || { echo "FATAL: /opt/samba/SAMBA missing"; exit 1; }

    # Perl local::lib usable
    perl -Mlocal::lib=/opt/samba/perl5libs -e1 || { echo "FATAL: local::lib not usable"; exit 1; }
    perl -MFile::Basename -e1 || { echo "FATAL: File::Basename not available"; exit 1; }
    perl -MFile::Path -e1 || { echo "FATAL: File::Path not available"; exit 1; }

    # FSL present (from base image)
    command -v fslmaths >/dev/null 2>&1 || { echo "FATAL: fslmaths not in PATH"; exit 1; }
    fslmaths -version >/dev/null 2>&1 || true

    # Atlas present and non-empty (basic sanity)
    [ -d "/opt/atlases/chass_symmetric3" ] || { echo "FATAL: atlas dir missing"; exit 1; }
    [ -L "/opt/samba/atlas" ] || { echo "FATAL: /opt/samba/atlas symlink missing"; exit 1; }
    ls -1 /opt/atlases/chass_symmetric3/*.nii* >/dev/null 2>&1 || { echo "FATAL: atlas appears empty"; exit 1; }

%runscript
    #!/bin/sh
    exec /bin/bash "$@"
