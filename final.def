Bootstrap: localimage
From: fsl_mcr.sif

%labels
    Stage       final
    Maintainer  BJ + ChatGPT (final stage: SAMBA + atlas + scheduler proxy)

%environment
    export SAMBA_ROOT=/opt/samba
    export SAMBA_PATH=/opt/samba/SAMBA
    export PERL_LOCAL_LIB_ROOT=/opt/samba/perl5libs
    export PERL_MB_OPT='--install_base "/opt/samba/perl5libs"'
    export PERL_MM_OPT='INSTALL_BASE=/opt/samba/perl5libs'
    export PERL5LIB=/opt/samba/perl5libs/lib/perl5
    export PATH="/opt/samba/bin:/opt/samba/perl5libs/bin:/opt/samba/perl5/bin:/opt/samba/ants/bin:/opt/samba/fsl/bin:/opt/samba/SAMBA:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"

%post
    set -eu

    SAMBA_ROOT=/opt/samba
    SAMBA_PATH=/opt/samba/SAMBA
    PERL_LOCAL_LIB_ROOT=/opt/samba/perl5libs

    ATLAS_FOLDER=/opt/atlases
    ZENODO_ID=15178373
    DEST_DIR=/opt/atlases
    CACHE_DIR=/opt/zenodo_cache
    SAMBA_ATLAS_DIR=/opt/atlases/chass_symmetric3

    mkdir -p /opt/src "${SAMBA_ROOT}" /opt/samba/perl5 /opt/samba/perl5libs \
             "${ATLAS_FOLDER}" "${CACHE_DIR}"

    echo "[final] starting final stage..."

    syscurl() {
        env -i \
            PATH=/usr/sbin:/usr/bin:/sbin:/bin \
            LD_LIBRARY_PATH=/usr/lib/x86_64-linux-gnu:/lib/x86_64-linux-gnu \
            /usr/bin/curl "$@"
    }

    echo "[final] fetching SAMBA repo..."
    if [ ! -d /opt/src/SAMBA ]; then
        git clone https://github.com/andersonion/SAMBA.git /opt/src/SAMBA
    fi
    git -C /opt/src/SAMBA fetch --all --tags --prune
    git -C /opt/src/SAMBA checkout -f -B buildpin origin/master

    echo "[final] installing SAMBA into ${SAMBA_PATH}..."
    rm -rf "${SAMBA_PATH}.tmp"
    rsync -a --delete /opt/src/SAMBA/ "${SAMBA_PATH}.tmp"/
    mv -f "${SAMBA_PATH}.tmp" "${SAMBA_PATH}"
    chmod -R a+rX "${SAMBA_PATH}"

    echo "[final] bootstrapping cpanm (App::cpanminus) if needed..."
    if ! command -v cpanm >/dev/null 2>&1; then
        syscurl -fsSL https://cpanmin.us | perl - App::cpanminus
    fi

    echo "[final] installing Perl toolchain (local::lib + Carton)..."
    cpanm --quiet --notest --local-lib="${PERL_LOCAL_LIB_ROOT}" local::lib Carton

    CARTON_BIN="/opt/samba/perl5libs/bin/carton"
    if [ ! -x "${CARTON_BIN}" ]; then
        echo "FATAL: ${CARTON_BIN} missing after cpanm install" >&2
        exit 1
    fi

    cd "${SAMBA_PATH}"
    echo "[carton] warm install..."
    env -i \
        PATH="/opt/samba/perl5libs/bin:/usr/sbin:/usr/bin:/sbin:/bin" \
        LC_ALL=C \
        DEBIAN_FRONTEND=noninteractive \
        LD_LIBRARY_PATH="/usr/lib/x86_64-linux-gnu:/lib/x86_64-linux-gnu" \
        PERL5LIB="/opt/samba/perl5libs/lib/perl5" \
        "${CARTON_BIN}" install --path "/opt/samba/perl5libs"

    if [ -f "cpanfile.snapshot" ]; then
        env -i \
            PATH="/opt/samba/perl5libs/bin:/usr/sbin:/usr/bin:/sbin:/bin" \
            LC_ALL=C \
            DEBIAN_FRONTEND=noninteractive \
            LD_LIBRARY_PATH="/usr/lib/x86_64-linux-gnu:/lib/x86_64-linux-gnu" \
            PERL5LIB="/opt/samba/perl5libs/lib/perl5" \
            "${CARTON_BIN}" install --deployment --path "/opt/samba/perl5libs"
    fi

    echo "[atlas] embedding atlas from Zenodo..."
    mkdir -p "${ATLAS_FOLDER}" "${SAMBA_ATLAS_DIR}"
    cd "${ATLAS_FOLDER}"

    TMP_JSON="/tmp/zenodo_${ZENODO_ID}.json"
    syscurl -fsSL "https://zenodo.org/api/records/${ZENODO_ID}" -o "${TMP_JSON}"

    TARBALL_NAME="$(python3 - "$TMP_JSON" <<'PY'
import json,sys
j=json.load(open(sys.argv[1]))
files=j.get("files",[])
t=[f["key"] for f in files if f["key"].endswith(".tar.gz")]
print(t[0] if t else "")
PY
    )"

    if [ -n "${TARBALL_NAME}" ]; then
        syscurl -fL -o "${TARBALL_NAME}" \
            "https://zenodo.org/api/records/${ZENODO_ID}/files/${TARBALL_NAME}/content"
        tar -xzf "${TARBALL_NAME}" -C "${ATLAS_FOLDER}"
        rm -f "${TARBALL_NAME}"
    else
        req="chass_symmetric3_T2.nii.gz chass_symmetric3_DWI.nii.gz chass_symmetric3_FA.nii.gz chass_symmetric3_MD.nii.gz chass_symmetric3_MO.nii.gz chass_symmetric3_labels.nii.gz chass_symmetric3_labels_lookup.txt chass_symmetric3_mask.nii.gz"
        for k in $req; do
            syscurl -fL \
                -o "${SAMBA_ATLAS_DIR}/${k}" \
                "https://zenodo.org/api/records/${ZENODO_ID}/files/${k}/content"
        done
    fi

    chmod -R a+rX "${ATLAS_FOLDER}"

    echo "[final] installing SAMBA helper binaries and scheduler wrappers..."
    mkdir -p /opt/samba/bin

    if [ -d /opt/samba/SAMBA/samba_bin ]; then
        cp -f /opt/samba/SAMBA/samba_bin/* /opt/samba/bin/
    fi

    if [ -d /opt/samba/SAMBA/samba_sched_wrappers ]; then
        cp -f /opt/samba/SAMBA/samba_sched_wrappers/* /opt/samba/bin/
    fi

    chmod -R a+rx /opt/samba/bin
    echo "[final] done."

%test
    set -eu
    echo "[test] === final stage sanity checks ==="

    echo "[test] checking SAMBA_PATH..."
    SAMBA_PATH="/opt/samba/SAMBA"
    if [ ! -d "${SAMBA_PATH}" ]; then
        echo "FATAL: missing SAMBA_PATH: ${SAMBA_PATH}" >&2
        exit 1
    fi
    echo "  OK: SAMBA_PATH exists."

    echo "[test] checking atlas..."
    ATLAS_DIR="/opt/atlases/chass_symmetric3"
    if [ ! -d "${ATLAS_DIR}" ]; then
        echo "FATAL: atlas directory not found: ${ATLAS_DIR}" >&2
        exit 1
    fi

    for f in \
        chass_symmetric3_FA.nii.gz \
        chass_symmetric3_DWI.nii.gz \
        chass_symmetric3_labels.nii.gz \
        chass_symmetric3_mask.nii.gz
    do
        if [ ! -f "${ATLAS_DIR}/${f}" ]; then
            echo "FATAL: missing atlas file: ${ATLAS_DIR}/${f}" >&2
            exit 1
        fi
        echo "  OK: ${f}"
    done

    echo "[test] checking scheduler helpers..."
    for c in \
        sbatch squeue scancel sacct scontrol \
        samba_sched_sbatch samba_sched_squeue samba_sched_scancel samba_sched_sacct samba_sched_scontrol samba_sched_proxy
    do
        if [ ! -x "/opt/samba/bin/${c}" ]; then
            echo "FATAL: missing /opt/samba/bin/${c}" >&2
            exit 1
        fi
        echo "  OK: ${c}"
    done

    echo "[test] final checks COMPLETE."

%runscript
    #!/bin/sh
    set -eu
    echo "SAMBA runtime environment ready."
