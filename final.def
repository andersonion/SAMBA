Bootstrap: localimage
From: fsl_mcr.sif

%labels
	Stage: final
	Maintainer: BJ Anderson

%environment
	# --- Runtime env (kept minimal; MCR loader is already wired via ld.so.conf) ---
	export SAMBA_ROOT="/opt/samba"
	export SAMBA_PATH="/opt/samba/SAMBA"

	# Perl local::lib location for Carton-installed deps
	export PERL_LOCAL_LIB_ROOT="/opt/samba/perl5libs"
	export PERL5LIB="/opt/samba/perl5libs/lib/perl5"
	export PERL_MB_OPT='--install_base "/opt/samba/perl5libs"'
	export PERL_MM_OPT='INSTALL_BASE=/opt/samba/perl5libs'

	# Atlas dir exposed for pipeline defaults
	export SAMBA_ATLAS_DIR="/opt/atlases/chass_symmetric3"

	# PATH: perl5 local bins, FSL skinny, ANTs (from parent), SAMBA scripts, system
	export PATH="/opt/samba/perl5libs/bin:/opt/samba/perl5/bin:/opt/samba/fsl/bin:/opt/samba/ants/bin:/opt/samba/SAMBA:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"

%post
	set -eu

	# =========================
	# Vars
	# =========================
	SAMBA_ROOT="/opt/samba"
	SAMBA_PATH="${SAMBA_ROOT}/SAMBA"

	PERL_LOCAL_LIB_ROOT="/opt/samba/perl5libs"
	PERL5LIB="/opt/samba/perl5libs/lib/perl5"
	PERL_MB_OPT='--install_base "/opt/samba/perl5libs"'
	PERL_MM_OPT='INSTALL_BASE=/opt/samba/perl5libs'

	ATLAS_FOLDER="/opt/atlases"
	SAMBA_ATLAS_DIR="${ATLAS_FOLDER}/chass_symmetric3"
	ZENODO_ID="15178373"  # Mouse Brain Atlas Ex Vivo MRI

	export SAMBA_ROOT SAMBA_PATH PERL_LOCAL_LIB_ROOT PERL5LIB PERL_MB_OPT PERL_MM_OPT

	# =========================
	# Helpers
	# =========================
	_sysrun() {
		# Run with a clean env so MCR's older libstdc++ never leaks into system tools.
		env -i \
			PATH=/usr/sbin:/usr/bin:/sbin:/bin \
			LC_ALL=C \
			DEBIAN_FRONTEND=noninteractive \
			LD_LIBRARY_PATH=/usr/lib/x86_64-linux-gnu:/lib/x86_64-linux-gnu \
			"$@"
	}

	_mcr_shield_begin() {
		# Temporarily disable the MCR ld.so path so apt/curl use system libstdc++
		if [ -f /etc/ld.so.conf.d/mcr_v90.conf ]; then
			mv /etc/ld.so.conf.d/mcr_v90.conf /etc/ld.so.conf.d/mcr_v90.conf.disabled
			ldconfig
			: > /tmp/.mcr_shielded
		fi
	}

	_mcr_shield_end() {
		if [ -f /tmp/.mcr_shielded ]; then
			mv /etc/ld.so.conf.d/mcr_v90.conf.disabled /etc/ld.so.conf.d/mcr_v90.conf
			ldconfig
			rm -f /tmp/.mcr_shielded
		fi
	}

	# =========================
	# System deps (scrubbed env)
	# =========================
	_mcr_shield_begin
	_sysrun apt-get update
	_sysrun apt-get install -y --no-install-recommends \
		git rsync ca-certificates curl unzip \
		make gcc perl-modules cpanminus
	_sysrun apt-get clean
	_sysrun rm -rf /var/lib/apt/lists/*
	_mcr_shield_end

	# =========================
	# Layout
	# =========================
	mkdir -p /opt/src "${SAMBA_ROOT}" /opt/samba/perl5 /opt/samba/perl5libs
	chmod 0755 "${SAMBA_ROOT}"

	# =========================
	# Fetch & stage SAMBA (master)
	# =========================
	if [ ! -d /opt/src/SAMBA ]; then
		git clone https://github.com/andersonion/SAMBA.git /opt/src/SAMBA
	fi
	git -C /opt/src/SAMBA fetch --all --tags --prune
	# Your repo uses 'master'
	git -C /opt/src/SAMBA checkout -f -B buildpin origin/master

	rm -rf "${SAMBA_PATH}.tmp"
	rsync -a --delete /opt/src/SAMBA/ "${SAMBA_PATH}.tmp"/
	mv -f "${SAMBA_PATH}.tmp" "${SAMBA_PATH}"
	chmod -R a+rX "${SAMBA_PATH}"

	# =========================
	# Ensure Carton/local::lib available (no perlbrew)
	# =========================
	/usr/bin/cpanm --quiet --notest --local-lib="${PERL_LOCAL_LIB_ROOT}" local::lib Carton
	# (We are not running `carton install` at build-time to avoid pinning host-specific toolchains.)

	# =========================
	# Embed Atlas from Zenodo
	#  - If a .tar.gz exists, fetch and extract.
	#  - Otherwise download the expected files individually.
	# =========================
	mkdir -p "${ATLAS_FOLDER}" "${SAMBA_ATLAS_DIR}"
	cd "${ATLAS_FOLDER}"

	# Pull record JSON under clean env to avoid SSL/lib issues
	TMP_JSON="/tmp/zenodo_${ZENODO_ID}.json"
	_mcr_shield_begin
	_sysrun curl -fsSL "https://zenodo.org/api/records/${ZENODO_ID}" -o "${TMP_JSON}"
	_mcr_shield_end

	# Try to discover a tarball; fallback to individual files if none.
	TARBALL_NAME="$(
		python3 - "$TMP_JSON" <<'PY'
import json,sys
j=json.load(open(sys.argv[1]))
files=j.get("files",[])
t=[f["key"] for f in files if f["key"].endswith(".tar.gz")]
print(t[0] if t else "")
PY
	)"

	if [ -n "${TARBALL_NAME}" ]; then
		echo "[atlas] fetching tarball: ${TARBALL_NAME}"
		_mcr_shield_begin
		_sysrun curl -fL --retry 4 --retry-delay 2 \
			-o "${TARBALL_NAME}" \
			"https://zenodo.org/api/records/${ZENODO_ID}/files/${TARBALL_NAME}/content"
		_mcr_shield_end
		tar -xzf "${TARBALL_NAME}" -C "${ATLAS_FOLDER}"
		rm -f "${TARBALL_NAME}"
	else
		echo "[atlas] no tarball; fetching individual files into ${SAMBA_ATLAS_DIR}"
		mkdir -p "${SAMBA_ATLAS_DIR}"
		req="chass_symmetric3_T2.nii.gz chass_symmetric3_DWI.nii.gz chass_symmetric3_FA.nii.gz chass_symmetric3_MD.nii.gz chass_symmetric3_MO.nii.gz chass_symmetric3_labels.nii.gz chass_symmetric3_labels_lookup.txt chass_symmetric3_mask.nii.gz"
		for k in $req; do
			echo "  - $k"
			_mcr_shield_begin
			_sysrun curl -fL --retry 4 --retry-delay 2 \
				-o "${SAMBA_ATLAS_DIR}/${k}" \
				"https://zenodo.org/api/records/${ZENODO_ID}/files/${k}/content"
			_mcr_shield_end
		done
	fi

	chmod -R a+rX "${ATLAS_FOLDER}"

	# =========================
	# Final echo
	# =========================
	echo "[final] staged SAMBA at ${SAMBA_PATH}"
	echo "[final] atlas at ${SAMBA_ATLAS_DIR}"
	echo "[final] carton at: $(command -v carton || echo 'MISSING')"

%test
	set -eu
	echo "[test] minimal checksâ€¦"
	# Confirm core tools exist
	command -v perl >/dev/null
	command -v carton >/dev/null
	# Confirm atlas presence (either extracted dir populated or at least labels exist)
	if [ ! -d "/opt/atlases/chass_symmetric3" ]; then
		echo "FATAL: atlas directory missing"; exit 1
	fi
	# Quick file spot-check
	if ! ls /opt/atlases/chass_symmetric3/*labels* >/dev/null 2>&1; then
		echo "FATAL: atlas label file(s) missing"; exit 1
	fi
	echo "[test] OK"

%runscript
	#!/bin/sh
	set -eu
	echo "SAMBA container"
	echo "  Image: final stage"
	echo "  SAMBA: ${SAMBA_PATH}"
	echo "  Atlas: ${SAMBA_ATLAS_DIR}"
	echo
	echo "Examples:"
	echo "  singularity exec samba.sif samba-pipe /path/to/headfile"
